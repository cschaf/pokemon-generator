<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="appTitle">Pokémon Generator</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --light-bg: #f5f5f5;
            --light-text: #333;
            --light-controls-bg: #fff;
            --light-border: #ddd;
            --light-card-bg: #fff;
            --light-image-bg: #f0f0f0;
            --light-details-text: #666;
            --light-status-text: #666;
            --light-attribution-text: #888;
            --dark-bg: #1a1a1a;
            --dark-text: #eee;
            --dark-controls-bg: #2a2a2a;
            --dark-border: #555;
            --dark-card-bg: #3a3a3a;
            --dark-image-bg: #4a4a4a;
            --dark-details-text: #ccc;
            --dark-status-text: #ccc;
            --dark-attribution-text: #aaa;
            --primary-color: #e3350d; /* Pokémon Rot/Orange */
            --secondary-color: #3b5ca8; /* Pokémon Blau */
            --accent-color: #ff7863; /* Hellere Akzentfarbe für Dark Mode Header */
            --shiny-color: #FFD700; /* Gold für Shiny-Indikator */
        }

        body {
            font-family: 'Inter', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--light-bg);
            color: var(--light-text);
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
        }

        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
            font-weight: 700;
        }

        body.dark-mode h1 {
            color: var(--accent-color);
        }

        .description {
            text-align: center;
            margin-bottom: 20px;
            font-size: 0.95em;
            color: var(--light-details-text);
        }
        body.dark-mode .description {
            color: var(--dark-details-text);
        }

        .loading-progress-container {
            width: 100%;
            background-color: var(--light-border);
            border-radius: 8px;
            margin-bottom: 25px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        body.dark-mode .loading-progress-container {
            background-color: var(--dark-border);
            box-shadow: inset 0 1px 3px rgba(255,255,255,0.05);
        }

        .loading-progress-bar {
            width: 0%;
            height: 28px;
            background-color: var(--secondary-color);
            text-align: center;
            line-height: 28px;
            color: white;
            border-radius: 8px;
            transition: width 0.2s ease-out;
            position: relative;
        }
        body.dark-mode .loading-progress-bar {
             background-color: var(--accent-color);
        }

        .loading-progress-text {
            font-weight: 600;
            font-size: 0.85em;
            display: inline-block;
            padding: 0 10px;
            white-space: nowrap;
        }

        .controls {
            background-color: var(--light-controls-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        body.dark-mode .controls {
            background-color: var(--dark-controls-bg);
            box-shadow: 0 4px 10px rgba(255, 255, 255, 0.08);
        }

        .control-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; }
        body.dark-mode label { color: var(--dark-text); }

        select, input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light-border);
            border-radius: 5px;
            margin-bottom: 15px;
            background-color: var(--light-controls-bg);
            color: var(--light-text);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            box-sizing: border-box;
        }

        body.dark-mode select, body.dark-mode input[type="number"] {
            border-color: var(--dark-border);
            background-color: var(--dark-border);
            color: var(--dark-text);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px 15px; /* Increased gap slightly for better spacing of colored labels */
            margin-top: 10px;
        }

        .checkbox-item { display: flex; align-items: center; }
        .checkbox-item input[type="checkbox"] {
            width: auto; margin-right: 8px; margin-bottom: 0;
            min-width: 16px; min-height: 16px; flex-shrink: 0;
        }
        .checkbox-item label { 
            margin-bottom: 0; 
            font-weight: 400; 
            cursor: pointer; 
            flex-grow: 1; /* Allow label to take available space */
            display: block; /* Ensure padding and other block properties apply well */
        }
        
        /* Styling for Type Filter Labels */
        .type-filter-label {
            padding: 5px 10px;
            border-radius: 5px;
            color: white !important; /* Ensure text is white for contrast on colored backgrounds */
            text-align: center;
            font-weight: 600 !important; /* Make type names bold like on cards */
            transition: outline 0.1s ease-in-out, opacity 0.2s;
            border: 2px solid transparent; /* For consistent sizing with selected state */
        }

        /* Visual feedback for selected type filter labels */
        .checkbox-item input[type="checkbox"]:checked + label.type-filter-label {
            outline: 2px solid var(--primary-color);
            /* Optional: Slightly change opacity or add a subtle shadow */
            /* opacity: 0.85; */
        }
        body.dark-mode .checkbox-item input[type="checkbox"]:checked + label.type-filter-label {
            outline-color: var(--accent-color); /* Use accent color for outline in dark mode */
        }


        button {
            background-color: var(--secondary-color); color: white; border: none;
            padding: 12px 20px; border-radius: 5px; cursor: pointer;
            font-size: 16px; font-weight: 600;
            transition: background-color 0.3s, transform 0.1s ease-in-out;
            width: 100%; box-sizing: border-box;
        }
        button:hover { background-color: #2a4b8d; transform: translateY(-2px); }
        button:active { transform: translateY(0); }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        #results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 25px;
        }

        .pokemon-card {
            background-color: var(--light-card-bg);
            border-radius: 10px; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, background-color 0.3s, box-shadow 0.3s;
            display: flex; flex-direction: column;
        }
        body.dark-mode .pokemon-card {
            background-color: var(--dark-card-bg);
            box-shadow: 0 4px 10px rgba(255, 255, 255, 0.08);
        }
        .pokemon-card:hover { transform: translateY(-5px); }

        .pokemon-image {
            width: 100%; height: 180px;
            background-color: var(--light-image-bg);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: background-color 0.3s;
            position: relative;
        }
        body.dark-mode .pokemon-image { background-color: var(--dark-image-bg); }

        .pokemon-image img {
            max-width: 100%; max-height: 100%;
            object-fit: contain; transition: transform 0.3s ease-in-out;
        }
        .pokemon-image img:hover { transform: scale(1.05); }

        .shiny-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            color: var(--shiny-color);
            font-size: 1.3em; 
            display: none;
            text-shadow: 0 0 4px rgba(0,0,0,0.6); 
            z-index: 5;
            pointer-events: none;
        }
        .shiny-indicator.active { display: inline-block; }


        .pokemon-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .pokemon-name {
            margin: 0 0 8px 0; color: var(--light-text);
            font-size: 1.1em; font-weight: 700;
        }
        body.dark-mode .pokemon-name { color: var(--dark-text); }
        .pokemon-details {
            font-size: 0.9em; color: var(--light-details-text);
            margin: 0 0 5px 0;
        }
        body.dark-mode .pokemon-details { color: var(--dark-details-text); }
        .pokemon-types { margin-top: 10px; }
        .type-badge { /* This is for cards, .type-filter-label is for checkboxes */
            display: inline-block; padding: 4px 10px; border-radius: 5px;
            font-size: 0.85em; color: white; margin-right: 8px; margin-bottom: 5px;
            font-weight: 600; text-transform: capitalize;
        }

        #status {
            margin: 20px 0; font-style: italic; text-align: center;
            color: var(--light-status-text); min-height: 1.5em;
        }
        body.dark-mode #status { color: var(--dark-status-text); }

        .attribution {
            text-align: center; margin-top: 40px; font-size: 0.8em;
            color: var(--light-attribution-text);
        }
        body.dark-mode .attribution { color: var(--dark-attribution-text); }
        .attribution a { color: inherit; text-decoration: underline; }
        .attribution a:hover { text-decoration: none; }

        .top-right-icons {
            position: absolute; top: 20px; right: 20px;
            display: flex; align-items: center; gap: 15px; z-index: 10;
        }
        .language-switcher img {
            width: 28px; height: auto; cursor: pointer;
            border: 2px solid transparent; border-radius: 4px;
            transition: border-color 0.3s, transform 0.1s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        body.dark-mode .language-switcher img { box-shadow: 0 2px 5px rgba(255, 255, 255, 0.08); }
        .language-switcher img:hover { transform: scale(1.1); }
        .language-switcher img.active { border-color: var(--secondary-color); }

        .theme-switcher i {
            font-size: 28px; cursor: pointer; color: var(--light-text);
            transition: color 0.3s, transform 0.1s ease-in-out;
        }
        body.dark-mode .theme-switcher i { color: var(--dark-text); }
        .theme-switcher i:hover { transform: rotate(15deg); }

        /* Type colors (used for card badges AND checkbox labels) */
        .type-normal { background-color: #A8A878; } .type-fire { background-color: #F08030; }
        .type-water { background-color: #6890F0; } .type-electric { background-color: #F8D030; }
        .type-grass { background-color: #78C850; } .type-ice { background-color: #98D8D8; }
        .type-fighting { background-color: #C03028; } .type-poison { background-color: #A040A0; }
        .type-ground { background-color: #E0C068; } .type-flying { background-color: #A890F0; }
        .type-psychic { background-color: #F85888; } .type-bug { background-color: #A8B820; }
        .type-rock { background-color: #B8A038; } .type-ghost { background-color: #705898; }
        .type-dragon { background-color: #7038F8; } .type-dark { background-color: #705848; }
        .type-steel { background-color: #B8B8D0; } .type-fairy { background-color: #EE99AC; }

        @media (max-width: 768px) {
            body { padding: 15px; }
            .top-right-icons { top: 10px; right: 10px; gap: 10px; }
            .language-switcher img, .theme-switcher i { font-size: 20px; width: 20px; }
            .controls { padding: 15px; }
            .checkbox-group { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px 10px; }
            .type-filter-label { padding: 4px 8px; font-size: 0.9em;}
            button { padding: 10px 15px; }
            #results { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
            .pokemon-card { border-radius: 8px; }
            .pokemon-image { height: 120px; }
            .shiny-indicator { font-size: 1.1em; top: 5px; right: 5px; }
            .pokemon-info { padding: 10px; }
            .pokemon-name { font-size: 1em; }
            .pokemon-details { font-size: 0.85em; }
            .type-badge { padding: 3px 8px; font-size: 0.8em; margin-right: 5px; }
            #status { margin: 15px 0; font-size: 0.9em; }
            .attribution { margin-top: 20px; font-size: 0.75em; }
        }
         @media (max-width: 480px) {
             .checkbox-group { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
             .loading-progress-text { font-size: 0.8em; }
             .type-filter-label { padding: 3px 6px; font-size: 0.85em;}
         }
    </style>
</head>
<body>
    <h1 data-i18n="appTitle">Pokémon Generator</h1>

     <div class="top-right-icons">
         <div class="language-switcher">
            <img src="https://flagcdn.com/de.svg" data-lang="de" alt="Deutsche Flagge" class="active">
            <img src="https://flagcdn.com/us.svg" data-lang="en" alt="US Flagge">
        </div>
         <div class="theme-switcher">
             <i id="darkModeToggle" class="fas fa-moon"></i>
         </div>
     </div>

     <div class="description" data-i18n="siteDescription"></div>

     <div id="loading-progress-container" class="loading-progress-container" style="display: none;">
        <div id="loading-progress-bar" class="loading-progress-bar">
            <span id="loading-progress-text" class="loading-progress-text"></span>
        </div>
    </div>

    <div class="controls">
        <div class="control-group">
            <label for="count" data-i18n="countLabel">Anzahl der zu generierenden Pokémon:</label>
            <input type="number" id="count" min="1" max="100" value="10">
        </div>

        <div class="control-group">
            <label data-i18n="generationLabel">Generation:</label>
            <div class="checkbox-group">
                <div class="checkbox-item"><input type="checkbox" id="allGen" checked><label for="allGen" data-i18n="allLabel">Alle</label></div>
                <div class="checkbox-item"><input type="checkbox" id="gen1" class="gen-checkbox" value="1"><label for="gen1">Gen 1</label></div>
                <div class="checkbox-item"><input type="checkbox" id="gen2" class="gen-checkbox" value="2"><label for="gen2">Gen 2</label></div>
                <div class="checkbox-item"><input type="checkbox" id="gen3" class="gen-checkbox" value="3"><label for="gen3">Gen 3</label></div>
                <div class="checkbox-item"><input type="checkbox" id="gen4" class="gen-checkbox" value="4"><label for="gen4">Gen 4</label></div>
                <div class="checkbox-item"><input type="checkbox" id="gen5" class="gen-checkbox" value="5"><label for="gen5">Gen 5</label></div>
                <div class="checkbox-item"><input type="checkbox" id="gen6" class="gen-checkbox" value="6"><label for="gen6">Gen 6</label></div>
                <div class="checkbox-item"><input type="checkbox" id="gen7" class="gen-checkbox" value="7"><label for="gen7">Gen 7</label></div>
                <div class="checkbox-item"><input type="checkbox" id="gen8" class="gen-checkbox" value="8"><label for="gen8">Gen 8</label></div>
                <div class="checkbox-item"><input type="checkbox" id="gen9" class="gen-checkbox" value="9"><label for="gen9">Gen 9</label></div>
            </div>
        </div>

        <div class="control-group">
            <label data-i18n="typesLabel">Typen:</label>
            <div class="checkbox-group">
                <div class="checkbox-item"><input type="checkbox" id="allTypes" checked><label for="allTypes" data-i18n="allLabel">Alle</label></div>
                <div class="checkbox-item"><input type="checkbox" id="normal" class="type-checkbox"><label for="normal" data-i18n="type_normal">Normal</label></div>
                <div class="checkbox-item"><input type="checkbox" id="fire" class="type-checkbox"><label for="fire" data-i18n="type_fire">Feuer</label></div>
                <div class="checkbox-item"><input type="checkbox" id="water" class="type-checkbox"><label for="water" data-i18n="type_water">Wasser</labe></div>
                <div class="checkbox-item"><input type="checkbox" id="electric" class="type-checkbox"><label for="electric" data-i18n="type_electric">Elektro</label></div>
                <div class="checkbox-item"><input type="checkbox" id="grass" class="type-checkbox"><label for="grass" data-i18n="type_grass">Pflanze</label></div>
                <div class="checkbox-item"><input type="checkbox" id="ice" class="type-checkbox"><label for="ice" data-i18n="type_ice">Eis</label></div>
                <div class="checkbox-item"><input type="checkbox" id="fighting" class="type-checkbox"><label for="fighting" data-i18n="type_fighting">Kampf</label></div>
                <div class="checkbox-item"><input type="checkbox" id="poison" class="type-checkbox"><label for="poison" data-i18n="type_poison">Gift</labe></div>
                <div class="checkbox-item"><input type="checkbox" id="ground" class="type-checkbox"><label for="ground" data-i18n="type_ground">Boden</label></div>
                <div class="checkbox-item"><input type="checkbox" id="flying" class="type-checkbox"><label for="flying" data-i18n="type_flying">Flug</label></div>
                <div class="checkbox-item"><input type="checkbox" id="psychic" class="type-checkbox"><label for="psychic" data-i18n="type_psychic">Psycho</label></div>
                <div class="checkbox-item"><input type="checkbox" id="bug" class="type-checkbox"><label for="bug" data-i18n="type_bug">Käfer</label></div>
                <div class="checkbox-item"><input type="checkbox" id="rock" class="type-checkbox"><label for="rock" data-i18n="type_rock">Gestein</label></div>
                <div class="checkbox-item"><input type="checkbox" id="ghost" class="type-checkbox"><label for="ghost" data-i18n="type_ghost">Geist</label></div>
                <div class="checkbox-item"><input type="checkbox" id="dragon" class="type-checkbox"><label for="dragon" data-i18n="type_dragon">Drache</label></div>
                <div class="checkbox-item"><input type="checkbox" id="dark" class="type-checkbox"><label for="dark" data-i18n="type_dark">Unlicht</label></div>
                <div class="checkbox-item"><input type="checkbox" id="steel" class="type-checkbox"><label for="steel" data-i18n="type_steel">Stahl</label></div>
                <div class="checkbox-item"><input type="checkbox" id="fairy" class="type-checkbox"><label for="fairy" data-i18n="type_fairy">Fee</label></div>
            </div>
        </div>

        <div class="control-group">
            <label data-i18n="evolutionPositionLabel">Evolution (Position in Kette):</label>
            <div class="checkbox-group">
                <div class="checkbox-item"><input type="checkbox" id="allEvolutions" checked><label for="allEvolutions" data-i18n="allLabel">Alle</label></div>
                <div class="checkbox-item"><input type="checkbox" id="basic" class="evo-position-checkbox" value="0"><label for="basic" data-i18n="evo_basic">Grundform</label></div>
                <div class="checkbox-item"><input type="checkbox" id="stage1" class="evo-position-checkbox" value="1"><label for="stage1" data-i18n="evo_stage1">Erste Entwicklung</label></div>
                <div class="checkbox-item"><input type="checkbox" id="stage2" class="evo-position-checkbox" value="2"><label for="stage2" data-i18n="evo_stage2">Zweite Entwicklung</label></div>
            </div>
        </div>

        <div class="control-group">
            <label data-i18n="evolutionChainLengthLabel">Anzahl Entwicklungstufen (Gesamtlänge der Reihe):</label>
            <div class="checkbox-group">
                <div class="checkbox-item"><input type="checkbox" id="allChainLengths" checked><label for="allChainLengths" data-i18n="allLabel">Alle</label></div>
                <div class="checkbox-item"><input type="checkbox" id="chainLength1" class="chain-length-checkbox" value="1"><label for="chainLength1" data-i18n="chain_length1">Keine Entwicklung (1 Stufe)</label></div>
                <div class="checkbox-item"><input type="checkbox" id="chainLength2" class="chain-length-checkbox" value="2"><label for="chainLength2" data-i18n="chain_length2">Eine Entwicklung (2 Stufen)</label></div>
                <div class="checkbox-item"><input type="checkbox" id="chainLength3" class="chain-length-checkbox" value="3"><label for="chainLength3" data-i18n="chain_length3">Zwei Entwicklungen (3 Stufen)</label></div>
            </div>
        </div>

        <div class="control-group">
            <label data-i18n="specialPokemonLabel">Spezielle Pokémon:</label>
            <div class="checkbox-group">
                <div class="checkbox-item"><input type="checkbox" id="includeLegendary" checked><label for="includeLegendary" data-i18n="includeLegendaryLabel">Legendäre Pokémon</label></div>
                <div class="checkbox-item"><input type="checkbox" id="includeMythical" checked><label for="includeMythical" data-i18n="includeMythicalLabel">Mysteriöse Pokémon</label></div>
            </div>
        </div>

        <button id="generate" data-i18n="generateButton">Pokémon generieren!</button>
        <div id="status"></div>
    </div>

    <div id="results"></div>

    <div class="attribution" data-i18n="attributionText"></div>

    <script>
        const pokemonData = [];
        const evolutionChains = new Map(); 
        let isLoading = false;
        const POKEMON_LIMIT = 1300;
        const BASE_API_URL = 'https://pokeapi.co/api/v2/';
        const POKEMONDB_URL = 'https://pokemondb.net/pokedex/';
        const CACHE_KEY = 'pokemonGeneratorCache_v1'; 

        const loadingProgressContainer = document.getElementById('loading-progress-container');
        const loadingProgressBarElement = document.getElementById('loading-progress-bar');
        const loadingProgressTextElement = document.getElementById('loading-progress-text');

        const translations = {
            de: {
                appTitle: "Pokémon Generator",
                siteDescription: "Dieser Generator ermöglicht es dir, zufällige Pokémon basierend auf verschiedenen Filtern wie Generation, Typ und Evolutionsstufe zu generieren. Klicke auf ein Pokémon-Bild, um zwischen normaler und Shiny-Form zu wechseln. Klicke auf die Pokédex-Nummer oder den Namen, um weitere Details auf Pokémon Database zu finden.",
                countLabel: "Anzahl der zu generierenden Pokémon:",
                generationLabel: "Generation:", allLabel: "Alle", typesLabel: "Typen:",
                type_normal: "Normal", type_fire: "Feuer", type_water: "Wasser", type_electric: "Elektro", type_grass: "Pflanze", type_ice: "Eis", type_fighting: "Kampf", type_poison: "Gift", type_ground: "Boden", type_flying: "Flug", type_psychic: "Psycho", type_bug: "Käfer", type_rock: "Gestein", type_ghost: "Geist", type_dragon: "Drache", type_dark: "Unlicht", type_steel: "Stahl", type_fairy: "Fee",
                evolutionPositionLabel: "Evolution (Position in Kette):",
                evo_basic: "Grundform", evo_stage1: "Erste Entwicklung", evo_stage2: "Zweite Entwicklung",
                evolutionChainLengthLabel: "Anzahl Entwicklungstufen (Gesamtlänge der Reihe):",
                chain_length1: "Keine Entwicklung (1 Stufe)", chain_length2: "Eine Entwicklung (2 Stufen)", chain_length3: "Zwei Entwicklungen (3 Stufen)",
                specialPokemonLabel: "Spezielle Pokémon:",
                includeLegendaryLabel: "Legendäre Pokémon", includeMythicalLabel: "Mysteriöse Pokémon",
                generateButton: "Pokémon generieren!",
                loadingData: "Lade Pokémon-Daten von der PokeAPI...",
                loadedFromCache: "Pokémon-Daten aus Cache geladen!",
                progressText: (loaded, total) => `${loaded} / ${total} Pokémon verarbeitet`,
                loadingError: "Fehler beim Laden der Pokémon-Daten:",
                noPokemonFound: "Keine Pokémon entsprechen deinen Filtern!",
                generatedStatus: (generated, total) => `${generated} Pokémon von ${total} möglichen generiert.`,
                cardGeneration: "Generation", cardEvolution: "Entwicklung", cardEvolutionNoEvo: "(Keine Entwicklung)", cardEvolutionStage: "Stufe", cardTotalStages: "Stufen gesamt:",
                darkModeToggle: "Dark Mode umschalten",
                attributionText: 'Daten und Bilder bereitgestellt von der <a href="https://pokeapi.co/" target="_blank">PokeAPI</a>.<br>Pokémon © 2025 Nintendo, Creatures Inc., Game Freak Inc. Alle Rechte vorbehalten.'
            },
            en: {
                appTitle: "Pokémon Generator",
                siteDescription: "This generator allows you to generate random Pokémon based on various filters such as generation, type, and evolution stage. Click on a Pokémon image to toggle between normal and shiny forms. Click on the Pokédex number or name to find more details on Pokémon Database.",
                countLabel: "Number of Pokémon to generate:",
                generationLabel: "Generation:", allLabel: "All", typesLabel: "Types:",
                type_normal: "Normal", type_fire: "Fire", type_water: "Water", type_electric: "Electric", type_grass: "Grass", type_ice: "Ice", type_fighting: "Fighting", type_poison: "Poison", type_ground: "Ground", type_flying: "Flying", type_psychic: "Psychic", type_bug: "Bug", type_rock: "Rock", type_ghost: "Ghost", type_dragon: "Dragon", type_dark: "Dark", type_steel: "Steel", type_fairy: "Fairy",
                evolutionPositionLabel: "Evolution (Position in chain):",
                evo_basic: "Basic Form", evo_stage1: "First Evolution", evo_stage2: "Second Evolution",
                evolutionChainLengthLabel: "Number of Evolution Stages (Total chain length):",
                chain_length1: "No Evolution (1 Stage)", chain_length2: "One Evolution (2 Stages)", chain_length3: "Two Evolutions (3 Stages)",
                specialPokemonLabel: "Special Pokémon:",
                includeLegendaryLabel: "Legendary Pokémon", includeMythicalLabel: "Mythical Pokémon",
                generateButton: "Generate Pokémon!",
                loadingData: "Loading Pokémon data from PokeAPI...",
                loadedFromCache: "Pokémon data loaded from cache!",
                progressText: (loaded, total) => `${loaded} / ${total} Pokémon processed`,
                loadingError: "Error loading Pokémon data:",
                noPokemonFound: "No Pokémon match your filters!",
                generatedStatus: (generated, total) => `${generated} Pokémon generated from ${total} possible.`,
                cardGeneration: "Generation", cardEvolution: "Evolution", cardEvolutionNoEvo: "(No evolution)", cardEvolutionStage: "Stage", cardTotalStages: "Total stages:",
                darkModeToggle: "Toggle Dark Mode",
                attributionText: 'Data and images provided by the <a href="https://pokeapi.co/" target="_blank">PokeAPI</a>.<br>Pokémon © 2025 Nintendo, Creatures Inc., Game Freak Inc. All Rights Reserved.'
            }
        };
        let currentLang = 'de';

        function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    if (key === "attributionText" || key === "siteDescription") {
                         element.innerHTML = translations[lang][key];
                    } else {
                        element.textContent = translations[lang][key];
                    }
                }
            });
            document.title = translations[lang].appTitle;

            document.querySelectorAll('.type-checkbox').forEach(checkbox => {
                 const label = document.querySelector(`label[for="${checkbox.id}"]`);
                 if (label && translations[lang] && translations[lang][`type_${checkbox.id}`]) {
                      label.textContent = translations[lang][`type_${checkbox.id}`];
                 }
            });
            // After text update, ensure styles are applied to type labels
            initializeTypeCheckboxStyles();


            const statusElement = document.getElementById('status');
            const otherLang = currentLang === 'de' ? 'en' : 'de';
            if (statusElement.textContent.includes(translations[otherLang].loadedFromCache.split(' ')[2])) {
                statusElement.textContent = translations[lang].loadedFromCache;
            } else if (pokemonData.length > 0 && (statusElement.textContent.includes("Pokémon") || statusElement.textContent.includes("Pokemon"))) {
                 statusElement.textContent = `${pokemonData.length} Pokémon ${lang === 'de' ? 'geladen!' : 'loaded!'}`;
            } else if (statusElement.textContent.includes(translations[otherLang].generatedStatus(0,0).split(" ")[1])) { 
                 const parts = statusElement.textContent.match(/(\d+)\s.*?\s(\d+)/);
                 if (parts && parts.length === 3) {
                    const generatedCount = parseInt(parts[1]);
                    statusElement.textContent = translations[lang].generatedStatus(generatedCount, filterPokemon().length); 
                 }
            } else if (statusElement.textContent.includes(translations[otherLang].noPokemonFound.split(" ")[0])) { 
                 statusElement.textContent = translations[lang].noPokemonFound;
            } else if (isLoading && loadingProgressContainer.style.display === 'none') {
                 statusElement.textContent = translations[lang].loadingData;
            }

            if (document.getElementById('results').innerHTML !== "") generateRandomPokemon();
            document.querySelectorAll('.language-switcher img').forEach(img => {
                img.classList.toggle('active', img.dataset.lang === lang);
            });
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
            updateDarkModeIcon(isDarkMode);
        }
        function updateDarkModeIcon(isDarkMode) {
            const darkModeIcon = document.getElementById('darkModeToggle');
            if (darkModeIcon) darkModeIcon.className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
        }

        function getEvolutionStage(pokemonName, chain, stage = 0) {
            const cleanPokemonName = pokemonName.split('-')[0];
            if (chain && chain.species && chain.species.name && chain.species.name.split('-')[0] === cleanPokemonName) return stage;
            if (chain && chain.evolves_to) {
                for (const evolvesTo of chain.evolves_to) {
                    const foundStage = getEvolutionStage(cleanPokemonName, evolvesTo, stage + 1);
                    if (foundStage !== -1) return foundStage;
                }
            }
            return -1;
        }
        function countStagesInChain(chain) {
            let maxDepth = 0;
            function traverse(currentChain, currentDepth) {
                maxDepth = Math.max(maxDepth, currentDepth);
                if (currentChain.evolves_to) currentChain.evolves_to.forEach(evolvesTo => traverse(evolvesTo, currentDepth + 1));
            }
            if (chain) traverse(chain, 1);
            return maxDepth;
        }

        async function fetchPokemonDataFromAPI() {
            const statusElement = document.getElementById('status');
            isLoading = true;
            document.getElementById('generate').disabled = true;

            const cachedDataJSON = localStorage.getItem(CACHE_KEY);
            if (cachedDataJSON) {
                try {
                    const cachedData = JSON.parse(cachedDataJSON);
                    if (cachedData.pokemon && cachedData.pokemon.length > 0) {
                        pokemonData.push(...cachedData.pokemon);
                        statusElement.textContent = translations[currentLang].loadedFromCache;
                        console.log(`Loaded ${pokemonData.length} Pokémon from cache.`);
                        if (loadingProgressContainer) loadingProgressContainer.style.display = 'none';
                        isLoading = false;
                        document.getElementById('generate').disabled = false;
                        generateRandomPokemon();
                        return; 
                    }
                } catch (e) {
                    console.error("Error parsing cached Pokémon data:", e);
                    localStorage.removeItem(CACHE_KEY);
                }
            }

            statusElement.textContent = translations[currentLang].loadingData;
            if (loadingProgressContainer) loadingProgressContainer.style.display = 'block';
            if (loadingProgressBarElement) loadingProgressBarElement.style.width = '0%';
            if (loadingProgressTextElement) loadingProgressTextElement.textContent = translations[currentLang].progressText(0, POKEMON_LIMIT);

            let loadedCount = 0;
            let totalToLoad = 0;
            let nonDefaultCount = 0;
            let errorInFetchCount = 0;

            try {
                const response = await fetch(`${BASE_API_URL}pokemon?limit=${POKEMON_LIMIT}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                totalToLoad = data.results.length;
                console.log(`Attempting to process ${totalToLoad} entries from API list.`);
                if (loadingProgressTextElement) loadingProgressTextElement.textContent = translations[currentLang].progressText(0, totalToLoad);

                const pokemonDetailsPromises = data.results.map(async (p) => {
                    let pokemonDetail = null;
                    try {
                        const detailResponse = await fetch(p.url);
                        if (!detailResponse.ok) throw new Error(`Detail fetch for ${p.name} failed: ${detailResponse.status}`);
                        const detailData = await detailResponse.json();
                        
                        if (detailData.is_default === false) {
                            nonDefaultCount++;
                            return null;
                        }

                        const speciesResponse = await fetch(detailData.species.url);
                        if (!speciesResponse.ok) throw new Error(`Species fetch for ${p.name} failed: ${speciesResponse.status}`);
                        const speciesData = await speciesResponse.json();

                        const generationUrl = speciesData.generation ? speciesData.generation.url : null;
                        let generation = generationUrl ? parseInt(generationUrl.match(/\/generation\/(\d+)\//)?.[1] || 0) : null;

                        let evolutionChainData = null, totalStages = 0;
                        if (speciesData.evolution_chain && speciesData.evolution_chain.url) {
                            const chainUrl = speciesData.evolution_chain.url;
                            if (evolutionChains.has(chainUrl)) evolutionChainData = evolutionChains.get(chainUrl);
                            else {
                                try {
                                    const chainResponse = await fetch(chainUrl);
                                    if (chainResponse.ok) {
                                        evolutionChainData = await chainResponse.json();
                                        evolutionChains.set(chainUrl, evolutionChainData);
                                    }
                                } catch (chainError) { console.warn(`Evo chain fetch error for ${p.name}:`, chainError); }
                            }
                            if (evolutionChainData) totalStages = countStagesInChain(evolutionChainData.chain);
                        } else if (!speciesData.evolves_from_species) totalStages = 1;

                        let evolutionStage = -1;
                        if (evolutionChainData) evolutionStage = getEvolutionStage(detailData.name, evolutionChainData.chain);
                        else if (!speciesData.evolves_from_species) evolutionStage = 0;
                        
                        pokemonDetail = {
                            id: detailData.id, name: detailData.name,
                            germanName: speciesData.names.find(name => name.language.name === 'de')?.name || null,
                            types: detailData.types.map(typeInfo => typeInfo.type.name),
                            image: detailData.sprites.other['official-artwork'].front_default || detailData.sprites.front_default,
                            shinyImage: detailData.sprites.other['official-artwork'].front_shiny || detailData.sprites.front_shiny,
                            generation, evolutionStage, totalStages,
                            isLegendary: speciesData.is_legendary, isMythical: speciesData.is_mythical
                        };
                    } catch (error) { 
                        console.warn(`Error processing ${p.name}: ${error.message}`);
                        errorInFetchCount++;
                    } finally {
                        loadedCount++;
                        const progressPercent = totalToLoad > 0 ? (loadedCount / totalToLoad) * 100 : 0;
                        if (loadingProgressBarElement) loadingProgressBarElement.style.width = `${progressPercent}%`;
                        if (loadingProgressTextElement) loadingProgressTextElement.textContent = translations[currentLang].progressText(loadedCount, totalToLoad);
                    }
                    return pokemonDetail;
                });

                const results = await Promise.all(pokemonDetailsPromises);
                pokemonData.push(...results.filter(p => p !== null));
                pokemonData.sort((a, b) => a.id - b.id);
                
                console.log(`Total entries processed from API list: ${totalToLoad}`);
                console.log(`Filtered out as non-default forms: ${nonDefaultCount}`);
                console.log(`Failed to process due to errors: ${errorInFetchCount}`);
                console.log(`Successfully processed and added to pokemonData: ${pokemonData.length}`);
                
                try {
                    const dataToCache = { pokemon: pokemonData };
                    localStorage.setItem(CACHE_KEY, JSON.stringify(dataToCache));
                    console.log("Pokémon data saved to cache.");
                } catch (e) {
                    console.error("Error saving Pokémon data to cache:", e);
                }

                statusElement.textContent = `${pokemonData.length} Pokémon ${currentLang === 'de' ? 'geladen!' : 'loaded!'}`;
            } catch (error) {
                console.error("Fehler beim Laden der Pokémon-Daten von der PokeAPI:", error);
                statusElement.textContent = `${translations[currentLang].loadingError} ${error.message}`;
            } finally {
                isLoading = false;
                document.getElementById('generate').disabled = false;
                if (loadingProgressContainer) loadingProgressContainer.style.display = 'none';
                generateRandomPokemon();
            }
        }

        function filterPokemon() {
            let filtered = [...pokemonData];
            if (!document.getElementById('allGen').checked) {
                const selectedGens = Array.from(document.querySelectorAll('.gen-checkbox:checked')).map(cb => parseInt(cb.value));
                filtered = selectedGens.length > 0 ? filtered.filter(p => p.generation !== null && selectedGens.includes(p.generation)) : [];
            }
            if (!document.getElementById('allTypes').checked) {
                const selectedTypes = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.id);
                filtered = selectedTypes.length > 0 ? filtered.filter(p => p.types.some(type => selectedTypes.includes(type))) : [];
            }
            if (!document.getElementById('allEvolutions').checked) {
                const selectedPositions = new Set();
                if (document.getElementById('basic').checked) selectedPositions.add(0);
                if (document.getElementById('stage1').checked) selectedPositions.add(1);
                if (document.getElementById('stage2').checked) selectedPositions.add(2);
                filtered = selectedPositions.size > 0 ? filtered.filter(p => selectedPositions.has(p.evolutionStage)) : [];
            }
            if (!document.getElementById('allChainLengths').checked) {
                 const selectedLengths = new Set();
                 if (document.getElementById('chainLength1').checked) selectedLengths.add(1);
                 if (document.getElementById('chainLength2').checked) selectedLengths.add(2);
                 if (document.getElementById('chainLength3').checked) selectedLengths.add(3);
                 filtered = selectedLengths.size > 0 ? filtered.filter(p => selectedLengths.has(p.totalStages)) : [];
            }
            if (!document.getElementById('includeLegendary').checked) filtered = filtered.filter(p => !p.isLegendary);
            if (!document.getElementById('includeMythical').checked) filtered = filtered.filter(p => !p.isMythical);
            return filtered;
        }

        function generateRandomPokemon() {
            if (isLoading && loadingProgressContainer && loadingProgressContainer.style.display !== 'none') return;
            if (isLoading) { 
                 document.getElementById('status').textContent = translations[currentLang].loadingData;
                 return;
            }

            const count = parseInt(document.getElementById('count').value) || 10;
            const filteredPokemon = filterPokemon();
            const statusElement = document.getElementById('status');
            const resultsContainer = document.getElementById('results');
            resultsContainer.innerHTML = "";

            if (filteredPokemon.length === 0) {
                statusElement.textContent = translations[currentLang].noPokemonFound;
                return;
            }

            let selectedPokemon = count >= filteredPokemon.length ? [...filteredPokemon] : [...filteredPokemon].sort(() => 0.5 - Math.random()).slice(0, count);
            selectedPokemon.sort((a, b) => a.id - b.id);

            selectedPokemon.forEach(pokemon => {
                const card = document.createElement('div');
                card.className = 'pokemon-card';
                const displayedName = currentLang === 'de' && pokemon.germanName ? pokemon.germanName : capitalizeFirstLetter(pokemon.name);
                const pokemonDbUrl = `${POKEMONDB_URL}${pokemon.name}`;
                const typeHtml = pokemon.types.map(type => `<span class="type-badge type-${type}">${translations[currentLang][`type_${type}`] || capitalizeFirstLetter(type)}</span>`).join('');
                let specialStatusText = [
                    pokemon.isLegendary ? translations[currentLang].includeLegendaryLabel : null,
                    pokemon.isMythical ? translations[currentLang].includeMythicalLabel : null
                ].filter(Boolean).join(', ');

                let evolutionText = `${translations[currentLang].cardEvolution}: Unbekannt`;
                 if (pokemon.evolutionStage !== -1 && pokemon.totalStages !== undefined && pokemon.totalStages > 0) {
                      const numberOfEvolutions = pokemon.totalStages - 1;
                      evolutionText = `${translations[currentLang].cardEvolution}: ${pokemon.evolutionStage}/${numberOfEvolutions}`;
                      if (pokemon.evolutionStage === 0 && pokemon.totalStages === 1) evolutionText += ` ${translations[currentLang].cardEvolutionNoEvo}`;
                 } else if (pokemon.evolutionStage !== -1) { 
                      evolutionText = `${translations[currentLang].cardEvolution}: ${translations[currentLang].cardEvolutionStage} ${pokemon.evolutionStage}`;
                 }

                card.innerHTML = `
                    <div class="pokemon-image">
                        <img src="${pokemon.image || 'https://placehold.co/120x120/e0e0e0/333?text=Bild+fehlt'}" alt="${pokemon.name}"
                             data-normal="${pokemon.image || 'https://placehold.co/120x120/e0e0e0/333?text=Bild+fehlt'}"
                             data-shiny="${pokemon.shinyImage || 'https://placehold.co/120x120/e0e0e0/333?text=Shiny+fehlt'}"
                             onclick="toggleShiny(this)"
                             onerror="this.onerror=null; this.src='https://placehold.co/120x120/e0e0e0/333?text=Fehler'; this.dataset.normal='https://placehold.co/120x120/e0e0e0/333?text=Fehler';this.dataset.shiny='https://placehold.co/120x120/e0e0e0/333?text=Fehler';">
                        <span class="shiny-indicator"><img src="sparkles-icon.png" alt="Sparkles Icon" width=32 height=32/></span>
                    </div>
                    <div class="pokemon-info">
                        <h3 class="pokemon-name"><a href="${pokemonDbUrl}" target="_blank" class="pokedex-link">#${pokemon.id} ${displayedName}</a></h3>
                        <p class="pokemon-details">${translations[currentLang].cardGeneration}: ${pokemon.generation !== null ? pokemon.generation : 'Unbekannt'}</p>
                        <p class="pokemon-details">${evolutionText}</p>
                        <div class="pokemon-types">${typeHtml}</div>
                        ${specialStatusText ? `<p class="pokemon-details"><strong>${specialStatusText}</strong></p>` : ''}
                    </div>`;
                resultsContainer.appendChild(card);
            });
            statusElement.textContent = translations[currentLang].generatedStatus(selectedPokemon.length, filteredPokemon.length);
        }

        function toggleShiny(imgElement) {
            const currentSrc = imgElement.src;
            const normalSrc = imgElement.dataset.normal;
            const shinySrc = imgElement.dataset.shiny;
            const imageContainer = imgElement.parentElement;
            const indicator = imageContainer.querySelector('.shiny-indicator');

            if (shinySrc && shinySrc !== 'https://placehold.co/120x120/e0e0e0/333?text=Shiny+fehlt' && shinySrc !== 'https://placehold.co/120x120/e0e0e0/333?text=Fehler') {
                 if (currentSrc === normalSrc) {
                    imgElement.src = shinySrc;
                    if (indicator) indicator.classList.add('active');
                 } else {
                    imgElement.src = normalSrc;
                    if (indicator) indicator.classList.remove('active');
                 }
            }
        }

        function capitalizeFirstLetter(string) {
            return string ? string.charAt(0).toUpperCase() + string.slice(1) : '';
        }
        
        function initializeTypeCheckboxStyles() {
            document.querySelectorAll('input.type-checkbox').forEach(checkbox => {
                const label = document.querySelector(`label[for="${checkbox.id}"]`);
                if (label) {
                    // Ensure old type classes are removed if this function is ever called multiple times
                    label.className = label.className.replace(/type-\w+/g, '').trim(); 
                    
                    label.classList.add('type-filter-label');
                    label.classList.add(`type-${checkbox.id}`); // e.g., type-fire
                }
            });
        }

        function addFilterLogic() {
            const filterGroups = [
                { allId: 'allGen', specificClass: 'gen-checkbox' },
                { allId: 'allTypes', specificClass: 'type-checkbox' },
                { allId: 'allEvolutions', specificClass: 'evo-position-checkbox' },
                { allId: 'allChainLengths', specificClass: 'chain-length-checkbox' }
            ];

            filterGroups.forEach(group => {
                const allCheckbox = document.getElementById(group.allId);
                const specificCheckboxes = document.querySelectorAll('.' + group.specificClass);

                if (!allCheckbox || specificCheckboxes.length === 0) {
                    return;
                }

                specificCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            allCheckbox.checked = false;
                        } else {
                            const anySpecificChecked = Array.from(specificCheckboxes).some(cb => cb.checked);
                            if (!anySpecificChecked) {
                                allCheckbox.checked = true;
                            }
                        }
                    });
                });

                allCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        specificCheckboxes.forEach(cb => {
                            cb.checked = false;
                        });
                    }
                });
            });
        }

        document.getElementById('generate').addEventListener('click', generateRandomPokemon);
        document.querySelectorAll('.language-switcher img').forEach(img => {
            img.addEventListener('click', function() {
                setLanguage(this.dataset.lang);
                localStorage.setItem('language', this.dataset.lang);
            });
        });
        document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);

        window.addEventListener('load', function() {
             const savedDarkMode = localStorage.getItem('darkMode');
             const isDarkMode = savedDarkMode === 'enabled';
             if (isDarkMode) document.body.classList.add('dark-mode');
             updateDarkModeIcon(isDarkMode);

             const savedLang = localStorage.getItem('language');
             setLanguage((savedLang && translations[savedLang]) ? savedLang : 'de'); 
             
             initializeTypeCheckboxStyles(); // Apply styles to type checkboxes
             addFilterLogic(); 
             fetchPokemonDataFromAPI(); 
        });
    </script>
</body>
</html>
