<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="appTitle">Pokémon Generator</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css"> <!-- Updated FontAwesome version -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --light-bg: #f5f5f5;
            --light-text: #333;
            --light-controls-bg: #fff;
            --light-border: #ddd;
            --light-card-bg: #fff;
            --light-image-bg: #f0f0f0;
            --light-details-text: #666;
            --light-status-text: #666;
            --light-attribution-text: #888;
            --light-filter-group-bg: #f9f9f9; 
            --light-section-title-color: var(--secondary-color);
            --light-sticky-btn-bg: var(--secondary-color);
            --light-sticky-btn-text: white;
            --light-sticky-btn-hover-bg: #2a4a87;
            --light-sort-icon-color: #555;
            --light-sort-icon-active-color: var(--secondary-color);


            --dark-bg: #1a1a1a;
            --dark-text: #eee;
            --dark-controls-bg: #2a2a2a;
            --dark-border: #555;
            --dark-card-bg: #3a3a3a;
            --dark-image-bg: #4a4a4a;
            --dark-details-text: #ccc;
            --dark-status-text: #ccc;
            --dark-attribution-text: #aaa;
            --dark-filter-group-bg: #303030; 
            --dark-section-title-color: var(--accent-color);
            --dark-sticky-btn-bg: var(--accent-color);
            --dark-sticky-btn-text: var(--dark-bg);
            --dark-sticky-btn-hover-bg: var(--primary-color);
            --dark-sort-icon-color: #bbb;
            --dark-sort-icon-active-color: var(--accent-color);


            --primary-color: #e3350d; 
            --secondary-color: #3b5ca8; 
            --accent-color: #ff7863; 
            --shiny-color: #FFD700; 
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--light-bg);
            color: var(--light-text);
            transition: background-color 0.3s, color 0.3s;
            line-height: 1.6;
        }

        body.dark-mode {
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px; 
            font-weight: 700;
            font-size: 2.2em; 
        }

        body.dark-mode h1 {
            color: var(--accent-color);
        }

        .description {
            text-align: center;
            margin-bottom: 20px;
            font-size: 0.95em;
            color: var(--light-details-text);
        }
        body.dark-mode .description {
            color: var(--dark-details-text);
        }

        .loading-progress-container {
            width: 100%;
            background-color: var(--light-border);
            border-radius: 8px;
            margin-bottom: 25px;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        body.dark-mode .loading-progress-container {
            background-color: var(--dark-border);
            box-shadow: inset 0 1px 3px rgba(255,255,255,0.05);
        }

        .loading-progress-bar {
            width: 0%;
            height: 28px;
            background-color: var(--secondary-color);
            text-align: center;
            line-height: 28px;
            color: white;
            border-radius: 8px;
            transition: width 0.2s ease-out;
            position: relative;
        }
        body.dark-mode .loading-progress-bar {
             background-color: var(--accent-color);
        }

        .loading-progress-text {
            font-weight: 600;
            font-size: 0.85em;
            display: inline-block;
            padding: 0 10px;
            white-space: nowrap;
        }

        .controls {
            background-color: var(--light-controls-bg);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        body.dark-mode .controls {
            background-color: var(--dark-controls-bg);
            box-shadow: 0 4px 10px rgba(255, 255, 255, 0.08);
        }
        
        .global-collapse-controls {
            margin-bottom: 15px;
            text-align: right;
        }
        #toggleAllFiltersBtn {
            padding: 6px 12px;
            font-size: 0.9em;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        body.dark-mode #toggleAllFiltersBtn {
            background-color: var(--accent-color);
            color: var(--dark-bg);
        }


        .control-group { 
            margin-bottom: 10px; 
            border: 1px solid var(--light-border);
            border-radius: 8px;
            padding: 10px 15px; 
            background-color: var(--light-filter-group-bg);
            transition: background-color 0.3s, border-color 0.3s;
        }
        body.dark-mode .control-group {
            border-color: var(--dark-border);
            background-color: var(--dark-filter-group-bg);
        }
        
        .control-group-header {
            display: flex; 
            align-items: center;
            cursor: pointer; 
        }
        .control-group-header .label-and-toggle { 
            display: flex;
            align-items: center;
            flex-grow: 1; 
        }

        .control-group-header label { 
            margin-bottom: 0; 
        }

        .toggle-all-icon {
            font-size: 1.1em; 
            color: var(--secondary-color);
            cursor: pointer;
            margin-left: 10px; 
            transition: color 0.2s;
        }
        .toggle-all-icon:hover {
            color: var(--primary-color);
        }
        body.dark-mode .toggle-all-icon {
            color: var(--accent-color);
        }
        body.dark-mode .toggle-all-icon:hover {
            color: var(--primary-color);
        }

        .collapse-icon {
            margin-left: 10px; 
            font-size: 0.9em;
            transition: transform 0.3s ease-in-out;
        }
        .control-group.is-closed .collapse-icon {
            transform: rotate(-90deg);
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, padding-bottom 0.3s ease-out, margin-top 0.3s ease-out;
            padding-top: 10px; 
            padding-bottom: 5px; 
            margin-top: 5px; 
        }
        .control-group.is-closed .collapsible-content {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            margin-top: 0; 
        }


        label { display: block; margin-bottom: 8px; font-weight: 600; }
        body.dark-mode label { color: var(--dark-text); }

        select, input[type="number"].count-input { 
            width: 100%;
            padding: 10px;
            border: 1px solid var(--light-border);
            border-radius: 5px;
            background-color: var(--light-bg); 
            color: var(--light-text);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            box-sizing: border-box;
        }

        body.dark-mode select, body.dark-mode input[type="number"].count-input {
            border-color: var(--dark-border);
            background-color: var(--dark-bg);
            color: var(--dark-text);
        }
        .control-group:not(.collapsible) {
            background-color: transparent; 
            border: none;
            padding: 0 0 15px 0; 
        }


        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); 
            gap: 8px 12px; 
        }

        .checkbox-item { display: flex; align-items: center; }
        .checkbox-item input[type="checkbox"] {
            width: auto; margin-right: 8px; margin-bottom: 0;
            min-width: 16px; min-height: 16px; flex-shrink: 0;
        }
        .checkbox-item label { 
            margin-bottom: 0; 
            font-weight: 400; 
            cursor: pointer; 
            flex-grow: 1; 
            display: flex; 
            align-items: center;
        }
        
        .type-icon { 
            width: 20px; 
            height: 20px;
            margin-right: 6px; 
            vertical-align: middle; 
        }
        .type-filter-label { 
            padding: 3px 0px; 
            border-radius: 5px;
            text-align: left; 
            font-weight: 400 !important; 
            transition: outline 0.1s ease-in-out;
            border: 2px solid transparent; 
        }
        
        button#generate {
            background-color: var(--secondary-color); 
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s, color 0.3s, transform 0.1s ease-in-out;
            width: 100%;
            box-sizing: border-box;
            margin-top: 20px;
        }
        button#generate:hover {
            background-color: #2a4a87; 
            transform: translateY(-2px);
        }
        button#generate:active {
            transform: translateY(0);
        }
        button#generate:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        body.dark-mode button#generate {
            background-color: var(--accent-color); 
            color: var(--dark-bg); 
        }
        body.dark-mode button#generate:hover {
            background-color: var(--primary-color); 
            color: white; 
        }

        #locked-pokemon-section-container {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px dashed var(--light-border);
        }
        body.dark-mode #locked-pokemon-section-container {
            border-bottom-color: var(--dark-border);
        }
        #locked-pokemon-section-container h2 {
            text-align: center;
            font-size: 1.4em;
            color: var(--light-section-title-color);
            margin-bottom: 20px;
        }
        body.dark-mode #locked-pokemon-section-container h2 {
            color: var(--dark-section-title-color);
        }

        /* Regular results grid */
        #results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 25px;
            margin-top: 0; 
        }
        #locked-pokemon-section-container:not([style*="display: none"]) + #results {
             margin-top: 30px;
        }

        /* Locked Pokémon results grid - smaller cards */
        #locked-pokemon-results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); 
            gap: 15px; 
        }

        .pokemon-card {
            background-color: var(--light-card-bg);
            border-radius: 10px; overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, background-color 0.3s, box-shadow 0.3s;
            display: flex; flex-direction: column;
            position: relative; 
        }
        body.dark-mode .pokemon-card {
            background-color: var(--dark-card-bg);
            box-shadow: 0 4px 10px rgba(255, 255, 255, 0.08);
        }
        .pokemon-card:hover { transform: translateY(-5px); }

        .pokemon-image {
            width: 100%; height: 180px;
            background-color: var(--light-image-bg);
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; transition: background-color 0.3s;
            position: relative; 
        }
        body.dark-mode .pokemon-image { background-color: var(--dark-image-bg); }

        .pokemon-image img {
            max-width: 100%; max-height: 100%;
            object-fit: contain; transition: transform 0.3s ease-in-out;
        }
        .pokemon-image img:hover { transform: scale(1.05); }

        .shiny-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            content: "✨"; 
            font-size: 1.5em; 
            color: var(--shiny-color);
            display: none;
            text-shadow: 0 0 4px rgba(0,0,0,0.6); 
            z-index: 5;
            pointer-events: none;
        }
         .shiny-indicator.custom-icon { 
            content: ""; 
         }
        .shiny-indicator.active { display: inline-block; }

        .lock-icon {
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 1.5em;
            color: var(--light-status-text); 
            cursor: pointer;
            z-index: 6; 
            text-shadow: 0 0 4px rgba(0,0,0,0.3);
            transition: color 0.2s, transform 0.2s;
            padding: 2px; 
        }
        .lock-icon:hover {
            transform: scale(1.15);
        }
        .lock-icon.locked {
            color: var(--primary-color); 
        }
        body.dark-mode .lock-icon {
            color: var(--dark-status-text);
        }
        body.dark-mode .lock-icon.locked {
            color: var(--accent-color); 
        }


        .pokemon-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; }
        .pokemon-name {
            margin: 0 0 8px 0; color: var(--light-text);
            font-size: 1.1em; font-weight: 700;
            word-break: break-word; 
        }
        body.dark-mode .pokemon-name { color: var(--dark-text); }
        
        .pokedex-link {
            color: inherit; 
            text-decoration: none; 
            transition: color 0.2s, text-decoration 0.2s;
        }
        .pokedex-link:hover {
            text-decoration: underline; 
            color: var(--secondary-color); 
        }
        body.dark-mode .pokedex-link:hover {
             color: var(--accent-color); 
        }

        .pokemon-details {
            font-size: 0.9em; color: var(--light-details-text);
            margin: 0 0 5px 0;
        }
        body.dark-mode .pokemon-details { color: var(--dark-details-text); }
        
        .pokemon-types { 
            margin-top: 10px; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 8px 10px; 
        }
        .pokemon-type-item { 
            display: inline-flex;
            align-items: center;
        }
        .pokemon-type-item .type-icon { 
            width: 18px;
            height: 18px;
            margin-right: 4px; 
        }
        .pokemon-type-name { 
            font-size: 0.9em;
            color: var(--light-details-text);
            text-transform: capitalize;
            font-weight: 500; 
        }
        body.dark-mode .pokemon-type-name {
            color: var(--dark-details-text);
        }

        /* Styles for smaller locked cards */
        #locked-pokemon-results .pokemon-image { height: 100px; }
        #locked-pokemon-results .pokemon-info { padding: 10px; }
        #locked-pokemon-results .pokemon-name { font-size: 0.95em; margin-bottom: 5px; }
        #locked-pokemon-results .pokemon-details { font-size: 0.8em; margin-bottom: 3px;}
        #locked-pokemon-results .pokemon-types { margin-top: 6px; gap: 4px 6px; }
        #locked-pokemon-results .pokemon-type-item .type-icon { width: 14px; height: 14px; margin-right: 3px; }
        #locked-pokemon-results .pokemon-type-name { font-size: 0.8em; }
        #locked-pokemon-results .lock-icon { font-size: 1.2em; top: 5px; left: 5px; }
        #locked-pokemon-results .shiny-indicator { font-size: 1.2em; top: 5px; right: 5px; }


        #status {
            margin: 20px 0; font-style: italic; text-align: center;
            color: var(--light-status-text); min-height: 1.5em;
        }
        body.dark-mode #status { color: var(--dark-status-text); }

        .attribution {
            text-align: center; margin-top: 40px; font-size: 0.8em;
            color: var(--light-attribution-text);
        }
        body.dark-mode .attribution { color: var(--dark-attribution-text); }
        .attribution a { color: inherit; text-decoration: underline; }
        .attribution a:hover { text-decoration: none; }

        .page-actions-container { 
            position: fixed; 
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            flex-direction: column; 
            align-items: flex-end; 
            gap: 10px; 
        }
        .top-right-icons-group { 
             display: flex; align-items: center; gap: 15px;
        }

        .language-switcher img {
            width: 28px; height: auto; cursor: pointer;
            border: 2px solid transparent; border-radius: 4px;
            transition: border-color 0.3s, transform 0.1s ease-in-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        body.dark-mode .language-switcher img { box-shadow: 0 2px 5px rgba(255, 255, 255, 0.08); }
        .language-switcher img:hover { transform: scale(1.1); }
        .language-switcher img.active { border-color: var(--secondary-color); }

        .theme-switcher i {
            font-size: 28px; cursor: pointer; color: var(--light-text);
            transition: color 0.3s, transform 0.1s ease-in-out;
        }
        body.dark-mode .theme-switcher i { color: var(--dark-text); }
        .theme-switcher i:hover { transform: rotate(15deg); }

        #stickyGenerateBtn {
            display: none; 
            padding: 8px 15px;
            font-size: 0.9em;
            font-weight: 600;
            background-color: var(--light-sticky-btn-bg);
            color: var(--light-sticky-btn-text);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: background-color 0.3s, transform 0.1s ease-in-out, color 0.3s;
        }
        #stickyGenerateBtn:hover {
            background-color: var(--light-sticky-btn-hover-bg);
            transform: translateY(-1px);
        }
        #stickyGenerateBtn:disabled {
            background-color: #ccc !important; 
            color: #666 !important;
            cursor: not-allowed;
            transform: translateY(0);
        }
        body.dark-mode #stickyGenerateBtn {
            background-color: var(--dark-sticky-btn-bg);
            color: var(--dark-sticky-btn-text);
            box-shadow: 0 2px 8px rgba(255,255,255,0.1);
        }
         body.dark-mode #stickyGenerateBtn:hover {
            background-color: var(--dark-sticky-btn-hover-bg);
            color: white; 
        }

        #sorting-controls {
            display: none; /* Hidden by default */
            background-color: var(--light-controls-bg);
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        body.dark-mode #sorting-controls {
            background-color: var(--dark-controls-bg);
            box-shadow: 0 1px 5px rgba(255,255,255,0.1);
        }
        .sort-icon {
            cursor: pointer;
            font-size: 1.1em;
            padding: 3px 5px;
            color: var(--light-sort-icon-color);
            transition: color 0.2s;
            position: relative; /* For positioning the direction arrow */
            border-radius: 3px; /* Slight rounding for hover */
        }
        .sort-icon:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        .sort-icon.active {
            color: var(--light-sort-icon-active-color);
        }
        body.dark-mode .sort-icon {
            color: var(--dark-sort-icon-color);
        }
        body.dark-mode .sort-icon:hover {
             background-color: rgba(255, 255, 255, 0.1);
        }
        body.dark-mode .sort-icon.active {
            color: var(--dark-sort-icon-active-color);
        }
        #sort-direction {
             font-size: 0.9em; /* Smaller direction arrow */
             margin-left: -3px; /* Tuck it closer to the active icon */
        }


        #scrollToTopBtn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            border: none;
            outline: none;
            background-color: var(--secondary-color);
            color: white;
            cursor: pointer;
            padding: 10px 12px;
            border-radius: 50%;
            font-size: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: background-color 0.3s, transform 0.2s, color 0.3s;
        }
        #scrollToTopBtn:hover {
            background-color: #2a4a87;
            transform: translateY(-2px);
        }
        body.dark-mode #scrollToTopBtn {
            background-color: var(--accent-color);
            color: var(--dark-bg);
             box-shadow: 0 2px 8px rgba(255,255,255,0.1);
        }
        body.dark-mode #scrollToTopBtn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        @media (max-width: 768px) {
            h1 { font-size: 1.8em; margin-bottom: 20px;}
            body { padding: 15px; }
            .page-actions-container { top: 10px; right: 10px; gap: 8px;}
            .top-right-icons-group { gap: 10px; }
            .language-switcher img, .theme-switcher i { font-size: 22px; width: 22px; } 
            #stickyGenerateBtn { padding: 6px 10px; font-size: 0.8em; }
            #sorting-controls { gap: 5px; padding: 4px 8px; }
            .sort-icon { font-size: 1em; padding: 2px 4px;}
            #sort-direction { font-size: 0.8em; }

            #scrollToTopBtn { bottom: 15px; right: 15px; padding: 8px 10px; font-size: 16px; }

            .controls { padding: 15px; }
            .checkbox-group { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); } 
            button#generate { padding: 10px 15px; font-size: 1em; }
            
            /* Regular cards on mobile */
            #results { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
            #results .pokemon-image { height: 110px; }
            #results .pokemon-info { padding: 10px; }
            #results .pokemon-name { font-size: 0.9em; }
            #results .pokemon-details { font-size: 0.8em; }
            #results .pokemon-type-item .type-icon { width: 15px; height: 15px;}
            #results .pokemon-type-name { font-size: 0.8em; }
            #results .lock-icon, #results .shiny-indicator { font-size: 1em; }


            /* Locked cards on mobile - even smaller */
            #locked-pokemon-results { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
            #locked-pokemon-results .pokemon-image { height: 80px; }
            #locked-pokemon-results .pokemon-info { padding: 8px; }
            #locked-pokemon-results .pokemon-name { font-size: 0.8em; margin-bottom: 3px; }
            #locked-pokemon-results .pokemon-details { font-size: 0.7em; margin-bottom: 2px;}
            #locked-pokemon-results .pokemon-types { margin-top: 4px; gap: 3px 5px; }
            #locked-pokemon-results .pokemon-type-item .type-icon { width: 12px; height: 12px; margin-right: 2px; }
            #locked-pokemon-results .pokemon-type-name { font-size: 0.7em; }
            #locked-pokemon-results .lock-icon { font-size: 1em; top: 4px; left: 4px; }
            #locked-pokemon-results .shiny-indicator { font-size: 1em; top: 4px; right: 4px; }


            #status { margin: 15px 0; font-size: 0.9em; }
            .attribution { margin-top: 20px; font-size: 0.75em; }
            .toggle-all-icon { margin-left: 8px; margin-top: 0; font-size: 1em; } 
            .collapse-icon { margin-left: 8px; font-size: 0.8em;}
            #locked-pokemon-section-container h2 { font-size: 1.2em; }
        }
         @media (max-width: 480px) {
             h1 { font-size: 1.6em; margin-bottom: 15px;}
             body { padding: 10px; }
             .page-actions-container { top: 8px; right: 8px; gap: 6px;}
             .top-right-icons-group { gap: 8px; }
             .language-switcher img, .theme-switcher i { font-size: 20px; width: 20px; } 
             #stickyGenerateBtn { padding: 5px 8px; font-size: 0.75em; }
             #sorting-controls { flex-wrap: wrap; justify-content: flex-end; } /* Allow wrap on very small */
             #scrollToTopBtn { bottom: 10px; right: 10px; padding: 6px 8px; font-size: 14px; }
             
             .controls { padding: 10px; }
             .control-group { padding: 8px 10px; }
             .checkbox-group { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 6px 8px; } 
             .checkbox-item label { font-size: 0.85em; }
             .type-icon { width: 16px; height: 16px; margin-right: 4px; } 

             /* Regular cards on small mobile */
            #results { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); }
            #results .pokemon-image { height: 100px; }

             /* Locked cards on small mobile */
            #locked-pokemon-results { grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); }
            #locked-pokemon-results .pokemon-image { height: 70px; }
            #locked-pokemon-results .pokemon-name { font-size: 0.75em; }
            #locked-pokemon-results .pokemon-details { font-size: 0.65em; }
            #locked-pokemon-results .pokemon-type-item .type-icon { width: 11px; height: 11px; }
            #locked-pokemon-results .pokemon-type-name { font-size: 0.65em; }
             
             .loading-progress-text { font-size: 0.8em; }
         }
    </style>
</head>
<body>
    <h1 data-i18n="appTitle">Pokémon Generator</h1>

    <div class="page-actions-container">
        <div class="top-right-icons-group">
            <div class="language-switcher">
                <img src="https://flagcdn.com/de.svg" data-lang="de" alt="Deutsche Flagge" class="active">
                <img src="https://flagcdn.com/us.svg" data-lang="en" alt="US Flagge">
            </div>
            <div class="theme-switcher">
                <i id="darkModeToggle" class="fas fa-moon"></i>
            </div>
        </div>
        <button id="stickyGenerateBtn" data-i18n="generateButton">Pokémon generieren!</button>
        <div id="sorting-controls" style="display: none;"> <!-- Initially hidden -->
            <span class="sort-icon" data-sort="id" title="Sort by ID"><i class="fa-solid fa-hashtag"></i></span>
            <span class="sort-icon" data-sort="name" title="Sort by Name"><i class="fa-solid fa-arrow-down-a-z"></i></span>
            <span class="sort-icon" data-sort="type" title="Sort by Type"><i class="fa-solid fa-leaf"></i></span> <!-- Example icon for type -->
            <span class="sort-icon" data-sort="random" title="Sort Randomly"><i class="fa-solid fa-shuffle"></i></span>
            <i id="sort-direction" class="fas"></i> <!-- Direction icon -->
        </div>
    </div>


     <div class="description" data-i18n="siteDescription"></div>

     <div id="loading-progress-container" class="loading-progress-container" style="display: none;">
        <div id="loading-progress-bar" class="loading-progress-bar">
            <span id="loading-progress-text" class="loading-progress-text"></span>
        </div>
    </div>

    <div class="controls">
        <div class="control-group"> <label for="count" data-i18n="countLabel">Anzahl neuer Pokémon zum Generieren:</label>
            <input type="number" id="count" class="count-input" min="0" max="100" value="10"> 
        </div>

        <div class="global-collapse-controls">
            <button id="toggleAllFiltersBtn" data-i18n="expandAllLabel">Alle ausklappen</button>
        </div>

        <!-- Filter Groups (Collapsible) -->
        <div class="control-group collapsible"> 
            <div class="control-group-header">
                <div class="label-and-toggle">
                    <label data-i18n="generationLabel">Generation:</label>
                    <i class="toggle-all-icon" data-group="gen-checkbox" title=""></i>
                </div>
                <i class="fas fa-chevron-down collapse-icon"></i>
            </div>
            <div class="collapsible-content">
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="gen1" class="gen-checkbox" value="1"><label for="gen1" data-i18n="gen1_label">Gen 1 (Kanto)</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="gen2" class="gen-checkbox" value="2"><label for="gen2" data-i18n="gen2_label">Gen 2 (Johto)</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="gen3" class="gen-checkbox" value="3"><label for="gen3" data-i18n="gen3_label">Gen 3 (Hoenn)</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="gen4" class="gen-checkbox" value="4"><label for="gen4" data-i18n="gen4_label">Gen 4 (Sinnoh)</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="gen5" class="gen-checkbox" value="5"><label for="gen5" data-i18n="gen5_label">Gen 5 (Unova)</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="gen6" class="gen-checkbox" value="6"><label for="gen6" data-i18n="gen6_label">Gen 6 (Kalos)</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="gen7" class="gen-checkbox" value="7"><label for="gen7" data-i18n="gen7_label">Gen 7 (Alola)</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="gen8" class="gen-checkbox" value="8"><label for="gen8" data-i18n="gen8_label">Gen 8 (Galar)</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="gen9" class="gen-checkbox" value="9"><label for="gen9" data-i18n="gen9_label">Gen 9 (Paldea)</label></div>
                </div>
            </div>
        </div>
        <div class="control-group collapsible"> 
            <div class="control-group-header">
                <div class="label-and-toggle">
                    <label data-i18n="typesLabel">Typen:</label>
                    <i class="toggle-all-icon" data-group="type-checkbox" title=""></i>
                </div>
                <i class="fas fa-chevron-down collapse-icon"></i>
            </div>
            <div class="collapsible-content">
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="normal" class="type-checkbox"><label for="normal"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/normal.svg" class="type-icon" alt="Normal type icon"><span class="type-filter-label" data-i18n="type_normal">Normal</span></label></div>
                    <div class="checkbox-item"><input type="checkbox" id="fire" class="type-checkbox"><label for="fire"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/fire.svg" class="type-icon" alt="Fire type icon"><span class="type-filter-label" data-i18n="type_fire">Feuer</span></label></div>
                    <div class="checkbox-item"><input type="checkbox" id="water" class="type-checkbox"><label for="water"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/water.svg" class="type-icon" alt="Water type icon"><span class="type-filter-label" data-i18n="type_water">Wasser</span></label></div>
                    <div class="checkbox-item"><input type="checkbox" id="electric" class="type-checkbox"><label for="electric"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/electric.svg" class="type-icon" alt="Electric type icon"><span class="type-filter-label" data-i18n="type_electric">Elektro</span></label></div>
                    <div class="checkbox-item"><input type="checkbox" id="grass" class="type-checkbox"><label for="grass"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/grass.svg" class="type-icon" alt="Grass type icon"><span class="type-filter-label" data-i18n="type_grass">Pflanze</span></label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ice" class="type-checkbox"><label for="ice"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/ice.svg" class="type-icon" alt="Ice type icon"><span class="type-filter-label" data-i18n="type_ice">Eis</span></label></div>
                    <div class="checkbox-item"><input type="checkbox" id="fighting" class="type-checkbox"><label for="fighting"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/fighting.svg" class="type-icon" alt="Fighting type icon"><span class="type-filter-label" data-i18n="type_fighting">Kampf</span></label></div>
                    <div class="checkbox-item"><input type="checkbox" id="poison" class="type-checkbox"><label for="poison"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/poison.svg" class="type-icon" alt="Poison type icon"><span class="type-filter-label" data-i18n="type_poison">Gift</span></label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ground" class="type-checkbox"><label for="ground"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/ground.svg" class="type-icon" alt="Ground type icon"><span class="type-filter-label" data-i18n="type_ground">Boden</span></label></div>
                    <div class="checkbox-item"><input type="checkbox" id="flying" class="type-checkbox"><label for="flying"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/flying.svg" class="type-icon" alt="Flying type icon"><span class="type-filter-label" data-i18n="type_flying">Flug</span></label></div>
                    <div class="checkbox-item"><input type="checkbox" id="psychic" class="type-checkbox"><label for="psychic"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/psychic.svg" class="type-icon" alt="Psychic type icon"><span class="type-filter-label" data-i18n="type_psychic">Psycho</span></label></div>
                    <div class="checkbox-item"><input type="checkbox" id="bug" class="type-checkbox"><label for="bug"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/bug.svg" class="type-icon" alt="Bug type icon"><span class="type-filter-label" data-i18n="type_bug">Käfer</span></label></div>
                    <div class="checkbox-item"><input type="checkbox" id="rock" class="type-checkbox"><label for="rock"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/rock.svg" class="type-icon" alt="Rock type icon"><span class="type-filter-label" data-i18n="type_rock">Gestein</span></label></div>
                    <div class="checkbox-item"><input type="checkbox" id="ghost" class="type-checkbox"><label for="ghost"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/ghost.svg" class="type-icon" alt="Ghost type icon"><span class="type-filter-label" data-i18n="type_ghost">Geist</span></label></div>
                    <div class="checkbox-item"><input type="checkbox" id="dragon" class="type-checkbox"><label for="dragon"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/dragon.svg" class="type-icon" alt="Dragon type icon"><span class="type-filter-label" data-i18n="type_dragon">Drache</span></label></div>
                    <div class="checkbox-item"><input type="checkbox" id="dark" class="type-checkbox"><label for="dark"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/dark.svg" class="type-icon" alt="Dark type icon"><span class="type-filter-label" data-i18n="type_dark">Unlicht</span></label></div>
                    <div class="checkbox-item"><input type="checkbox" id="steel" class="type-checkbox"><label for="steel"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/steel.svg" class="type-icon" alt="Steel type icon"><span class="type-filter-label" data-i18n="type_steel">Stahl</span></label></div>
                    <div class="checkbox-item"><input type="checkbox" id="fairy" class="type-checkbox"><label for="fairy"><img src="https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/fairy.svg" class="type-icon" alt="Fairy type icon"><span class="type-filter-label" data-i18n="type_fairy">Fee</span></label></div>
                </div>
            </div>
        </div>
        <div class="control-group collapsible"> 
            <div class="control-group-header">
                <div class="label-and-toggle">
                    <label data-i18n="evolutionPositionLabel">Evolution (Position in Kette):</label>
                    <i class="toggle-all-icon" data-group="evo-position-checkbox" title=""></i>
                </div>
                <i class="fas fa-chevron-down collapse-icon"></i>
            </div>
            <div class="collapsible-content">
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="basic" class="evo-position-checkbox" value="0"><label for="basic" data-i18n="evo_basic">Grundform</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="stage1" class="evo-position-checkbox" value="1"><label for="stage1" data-i18n="evo_stage1">Erste Entwicklung</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="stage2" class="evo-position-checkbox" value="2"><label for="stage2" data-i18n="evo_stage2">Zweite Entwicklung</label></div>
                </div>
            </div>
        </div>
        <div class="control-group collapsible"> 
            <div class="control-group-header">
                <div class="label-and-toggle">
                    <label data-i18n="evolutionChainLengthLabel">Anzahl Entwicklungstufen (Gesamtlänge der Reihe):</label>
                    <i class="toggle-all-icon" data-group="chain-length-checkbox" title=""></i>
                </div>
                <i class="fas fa-chevron-down collapse-icon"></i>
            </div>
            <div class="collapsible-content">
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="chainLength1" class="chain-length-checkbox" value="1"><label for="chainLength1" data-i18n="chain_length1">Keine Entwicklung (1 Stufe)</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="chainLength2" class="chain-length-checkbox" value="2"><label for="chainLength2" data-i18n="chain_length2">Eine Entwicklung (2 Stufen)</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="chainLength3" class="chain-length-checkbox" value="3"><label for="chainLength3" data-i18n="chain_length3">Zwei Entwicklungen (3 Stufen)</label></div>
                </div>
            </div>
        </div>
        <div class="control-group collapsible"> 
             <div class="control-group-header">
                <div class="label-and-toggle">
                    <label data-i18n="specialPokemonLabel">Spezielle Pokémon:</label>
                    <i class="toggle-all-icon" data-group="special-checkbox" title=""></i>
                </div>
                <i class="fas fa-chevron-down collapse-icon"></i>
            </div>
            <div class="collapsible-content">
                <div class="checkbox-group">
                    <div class="checkbox-item"><input type="checkbox" id="includeLegendary" class="special-checkbox" checked><label for="includeLegendary" data-i18n="includeLegendaryLabel">Legendäre Pokémon</label></div>
                    <div class="checkbox-item"><input type="checkbox" id="includeMythical" class="special-checkbox" checked><label for="includeMythical" data-i18n="includeMythicalLabel">Mysteriöse Pokémon</label></div>
                </div>
            </div>
        </div>
        <!-- End Filter Groups -->

        <button id="generate" data-i18n="generateButton">Pokémon generieren!</button>
        <div id="status"></div>
    </div>

    <div id="locked-pokemon-section-container" style="display: none;">
        <h2 data-i18n="lockedPokemonSectionTitle">Gesperrte Pokémon</h2>
        <div id="locked-pokemon-results"></div>
    </div>

    <div id="results"></div>

    <button id="scrollToTopBtn" title="Nach oben scrollen"><i class="fas fa-arrow-up"></i></button>

    <div class="attribution" data-i18n="attributionText"></div>

    <script>
        const pokemonData = [];
        const evolutionChains = new Map(); 
        let isLoading = false;
        const POKEMON_LIMIT = 1300; 
        const BASE_API_URL = 'https://pokeapi.co/api/v2/';
        const POKEMONDB_URL = 'https://pokemondb.net/pokedex/';
        const TYPE_ICON_BASE_URL = 'https://cdn.jsdelivr.net/gh/partywhale/pokemon-type-icons@main/icons/';
        const CACHE_KEY = 'pokemonGeneratorCache_v4'; 
        const LOCKED_POKEMON_CACHE_KEY = 'lockedPokemonIds_v1';

        let lockedPokemonIds = new Set();
        let countForNewPokemons = 10; 
        let currentSortCriteria = 'id'; // 'id', 'name', 'type', 'random'
        let currentSortDirection = 'asc'; // 'asc', 'desc'

        const loadingProgressContainer = document.getElementById('loading-progress-container');
        const loadingProgressBarElement = document.getElementById('loading-progress-bar');
        const loadingProgressTextElement = document.getElementById('loading-progress-text');
        const lockedPokemonSectionContainer = document.getElementById('locked-pokemon-section-container');
        const lockedPokemonResultsContainer = document.getElementById('locked-pokemon-results');
        const resultsContainer = document.getElementById('results');
        const controlsDiv = document.querySelector('.controls');
        const mainGenerateBtn = document.getElementById('generate');
        const stickyGenerateBtn = document.getElementById('stickyGenerateBtn');
        const scrollToTopBtn = document.getElementById('scrollToTopBtn');
        const sortingControls = document.getElementById('sorting-controls');
        const sortDirectionIcon = document.getElementById('sort-direction');


        const ICON_SELECT_ALL = 'fa-solid fa-square-check';
        const ICON_DESELECT_ALL = 'fa-solid fa-square-minus';
        let allFiltersExpanded = true; 

        const translations = {
            de: {
                appTitle: "Pokémon Generator",
                siteDescription: "Dieser Generator ermöglicht es dir, zufällige Pokémon basierend auf verschiedenen Filtern zu generieren. Gesperrte Pokémon werden in einem eigenen Bereich oben angezeigt. Klicke auf ein Pokémon-Bild, um zwischen normaler und Shiny-Form zu wechseln. Klicke auf die Pokédex-Nummer oder den Namen, um weitere Details auf Pokémon Database zu finden.",
                countLabel: "Anzahl neuer Pokémon zum Generieren:",
                generationLabel: "Generation:", 
                typesLabel: "Typen:",
                typesLabelShort: "Typ", 
                tooltipSelectAll: "Alle auswählen", 
                tooltipDeselectAll: "Alle abwählen", 
                tooltipLock: "Pokémon sperren",
                tooltipUnlock: "Pokémon entsperren",
                lockedPokemonSectionTitle: "Gesperrte Pokémon",
                expandAllLabel: "Alle ausklappen",
                collapseAllLabel: "Alle einklappen",
                gen1_label: "Gen 1 (Kanto)", gen2_label: "Gen 2 (Johto)", gen3_label: "Gen 3 (Hoenn)", gen4_label: "Gen 4 (Sinnoh)", gen5_label: "Gen 5 (Einall)", gen6_label: "Gen 6 (Kalos)", gen7_label: "Gen 7 (Alola)", gen8_label: "Gen 8 (Galar)", gen9_label: "Gen 9 (Paldea)",
                type_normal: "Normal", type_fire: "Feuer", type_water: "Wasser", type_electric: "Elektro", type_grass: "Pflanze", type_ice: "Eis", type_fighting: "Kampf", type_poison: "Gift", type_ground: "Boden", type_flying: "Flug", type_psychic: "Psycho", type_bug: "Käfer", type_rock: "Gestein", type_ghost: "Geist", type_dragon: "Drache", type_dark: "Unlicht", type_steel: "Stahl", type_fairy: "Fee",
                evolutionPositionLabel: "Evolution (Position in Kette):",
                evo_basic: "Grundform", evo_stage1: "Erste Entwicklung", evo_stage2: "Zweite Entwicklung",
                evolutionChainLengthLabel: "Anzahl Entwicklungstufen (Gesamtlänge der Reihe):",
                chain_length1: "Keine Entwicklung (1 Stufe)", chain_length2: "Eine Entwicklung (2 Stufen)", chain_length3: "Zwei Entwicklungen (3 Stufen)",
                specialPokemonLabel: "Spezielle Pokémon:",
                includeLegendaryLabel: "Legendäre Pokémon", includeMythicalLabel: "Mysteriöse Pokémon",
                generateButton: "Pokémon generieren!",
                loadingData: "Lade Pokémon-Daten von der PokeAPI...",
                loadedFromCache: "Pokémon-Daten aus Cache geladen!",
                progressText: (loaded, total) => `${loaded} / ${total} Pokémon verarbeitet`,
                loadingError: "Fehler beim Laden der Pokémon-Daten:",
                status_locked_only: (locked) => `${locked} Pokémon gesperrt. Es wurden keine neuen Pokémon angefordert.`,
                status_locked_and_generated: (locked, generated, totalPossible) => `${locked} Pokémon gesperrt. ${generated} von ${totalPossible} passenden neuen Pokémon generiert.`,
                status_locked_no_new_match: (locked) => `${locked} Pokémon gesperrt. Keine weiteren neuen Pokémon entsprechen den Filtern.`,
                status_generated_only: (generated, totalPossible) => `${generated} von ${totalPossible} passenden neuen Pokémon generiert.`,
                status_no_new_match: "Keine neuen Pokémon entsprechen deinen Filtern.",
                status_no_pokemon_at_all: "Keine Pokémon (gesperrt oder neu) entsprechen deinen Filtern.",
                status_initial_prompt: "Wähle Filter und generiere Pokémon!",
                cardGeneration: "Generation", cardEvolution: "Entwicklung", cardEvolutionNoEvo: "(Keine Entwicklung)", cardEvolutionStage: "Stufe", cardTotalStages: "Stufen gesamt:",
                darkModeToggle: "Dark Mode umschalten",
                attributionText: 'Daten und Bilder bereitgestellt von der <a href="https://pokeapi.co/" target="_blank">PokeAPI</a>.<br>Pokémon © 2025 Nintendo, Creatures Inc., Game Freak Inc. Alle Rechte vorbehalten. Alle Bilder der Pokémon-Typen wurden von <a href="https://github.com/partywhale/pokemon-type-icons/" target="_blank">partywhale</a> bereitgestellt.'
            },
            en: {
                appTitle: "Pokémon Generator",
                siteDescription: "This generator allows you to generate random Pokémon based on various filters. Locked Pokémon are displayed in a separate section at the top. Click on a Pokémon image to toggle between normal and shiny forms. Click on the Pokédex number or name to find more details on Pokémon Database.",
                countLabel: "Number of new Pokémon to generate:",
                generationLabel: "Generation:", 
                typesLabel: "Types:",
                typesLabelShort: "Type", 
                tooltipSelectAll: "Select All", 
                tooltipDeselectAll: "Deselect All",
                tooltipLock: "Lock Pokémon",
                tooltipUnlock: "Unlock Pokémon",
                lockedPokemonSectionTitle: "Locked Pokémon",
                expandAllLabel: "Expand All",
                collapseAllLabel: "Collapse All",
                gen1_label: "Gen 1 (Kanto)", gen2_label: "Gen 2 (Johto)", gen3_label: "Gen 3 (Hoenn)", gen4_label: "Gen 4 (Sinnoh)", gen5_label: "Gen 5 (Unova)", gen6_label: "Gen 6 (Kalos)", gen7_label: "Gen 7 (Alola)", gen8_label: "Gen 8 (Galar)", gen9_label: "Gen 9 (Paldea)",
                type_normal: "Normal", type_fire: "Fire", type_water: "Water", type_electric: "Electric", type_grass: "Grass", type_ice: "Ice", type_fighting: "Fighting", type_poison: "Poison", type_ground: "Ground", type_flying: "Flying", type_psychic: "Psychic", type_bug: "Bug", type_rock: "Rock", type_ghost: "Ghost", type_dragon: "Dragon", type_dark: "Dark", type_steel: "Steel", type_fairy: "Fairy",
                evolutionPositionLabel: "Evolution (Position in chain):",
                evo_basic: "Basic Form", evo_stage1: "First Evolution", evo_stage2: "Second Evolution",
                evolutionChainLengthLabel: "Number of Evolution Stages (Total chain length):",
                chain_length1: "No Evolution (1 Stage)", chain_length2: "One Evolution (2 Stages)", chain_length3: "Two Evolutions (3 Stages)",
                specialPokemonLabel: "Special Pokémon:",
                includeLegendaryLabel: "Legendary Pokémon", includeMythicalLabel: "Mythical Pokémon",
                generateButton: "Generate Pokémon!",
                loadingData: "Loading Pokémon data from PokeAPI...",
                loadedFromCache: "Pokémon data loaded from cache!",
                progressText: (loaded, total) => `${loaded} / ${total} Pokémon processed`,
                loadingError: "Error loading Pokémon data:",
                status_locked_only: (locked) => `${locked} Pokémon locked. No new Pokémon requested.`,
                status_locked_and_generated: (locked, generated, totalPossible) => `${locked} Pokémon locked. ${generated} of ${totalPossible} matching new Pokémon generated.`,
                status_locked_no_new_match: (locked) => `${locked} Pokémon locked. No additional new Pokémon match filters.`,
                status_generated_only: (generated, totalPossible) => `${generated} of ${totalPossible} matching new Pokémon generated.`,
                status_no_new_match: "No new Pokémon match your filters.",
                status_no_pokemon_at_all: "No Pokémon (locked or new) match your filters.",
                status_initial_prompt: "Select filters and generate Pokémon!",
                cardGeneration: "Generation", cardEvolution: "Evolution", cardEvolutionNoEvo: "(No evolution)", cardEvolutionStage: "Stage", cardTotalStages: "Total stages:",
                darkModeToggle: "Toggle Dark Mode",
                attributionText: 'Data and images provided by the <a href="https://pokeapi.co/" target="_blank">PokeAPI</a>.<br>Pokémon © 2025 Nintendo, Creatures Inc., Game Freak Inc. All Rights Reserved. The images for all Pokémon types are provided by <a href="https://github.com/partywhale/pokemon-type-icons/" target="_blank">partywhale</a>.'
            }
        };
        let currentLang = 'de';

        function updateToggleIcon(groupClass) {
            const iconElement = document.querySelector(`.toggle-all-icon[data-group="${groupClass}"]`);
            if (!iconElement) return;
            const checkboxesInGroup = document.querySelectorAll(`.${groupClass}`);
            if (checkboxesInGroup.length === 0) { 
                iconElement.className = 'toggle-all-icon'; 
                iconElement.title = ''; return;
            }
            const allSelected = Array.from(checkboxesInGroup).every(cb => cb.checked);
            iconElement.className = `toggle-all-icon ${allSelected ? ICON_DESELECT_ALL : ICON_SELECT_ALL}`;
            iconElement.title = translations[currentLang][allSelected ? 'tooltipDeselectAll' : 'tooltipSelectAll'];
        }

        function setLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key] && typeof translations[lang][key] !== 'function') { 
                    if (key === "attributionText" || key === "siteDescription") {
                         element.innerHTML = translations[lang][key];
                    } else {
                         element.textContent = translations[lang][key];
                    }
                }
            });
            const toggleAllFiltersButton = document.getElementById('toggleAllFiltersBtn');
            if (toggleAllFiltersButton) {
                toggleAllFiltersButton.textContent = translations[currentLang][allFiltersExpanded ? 'collapseAllLabel' : 'expandAllLabel'];
                toggleAllFiltersButton.setAttribute('data-i18n', allFiltersExpanded ? 'collapseAllLabel' : 'expandAllLabel');
            }

            document.title = translations[lang].appTitle;
            document.querySelectorAll('.toggle-all-icon').forEach(icon => {
                if (icon.dataset.group) updateToggleIcon(icon.dataset.group);
            });
            
            if (pokemonData.length > 0 && !isLoading) { 
                 generateRandomPokemon(); 
            } else if (isLoading && loadingProgressContainer.style.display === 'none'){
                document.getElementById('status').textContent = translations[currentLang].loadingData;
            } else if (document.getElementById('status').textContent === "" && !isLoading && pokemonData.length === 0) {
                document.getElementById('status').textContent = translations[currentLang].status_initial_prompt;
            }


            document.querySelectorAll('.language-switcher img').forEach(img => {
                img.classList.toggle('active', img.dataset.lang === lang);
            });
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
            updateDarkModeIcon(isDarkMode);
        }
        function updateDarkModeIcon(isDarkMode) {
            const darkModeIcon = document.getElementById('darkModeToggle');
            if (darkModeIcon) darkModeIcon.className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';
        }

        function getEvolutionStage(pokemonName, chain, stage = 0) {
            const cleanPokemonName = pokemonName.split('-')[0];
            if (chain && chain.species && chain.species.name && chain.species.name.split('-')[0] === cleanPokemonName) return stage;
            if (chain && chain.evolves_to) {
                for (const evolvesTo of chain.evolves_to) {
                    const foundStage = getEvolutionStage(cleanPokemonName, evolvesTo, stage + 1);
                    if (foundStage !== -1) return foundStage;
                }
            }
            return -1;
        }
        function countStagesInChain(chain) {
            let maxDepth = 0;
            function traverse(currentChain, currentDepth) {
                maxDepth = Math.max(maxDepth, currentDepth);
                if (currentChain.evolves_to) currentChain.evolves_to.forEach(evolvesTo => traverse(evolvesTo, currentDepth + 1));
            }
            if (chain) traverse(chain, 1);
            return maxDepth;
        }

        async function fetchPokemonDataFromAPI() {
            const statusElement = document.getElementById('status');
            isLoading = true;
            mainGenerateBtn.disabled = true;
            stickyGenerateBtn.disabled = true;
            statusElement.textContent = translations[currentLang].loadingData; 

            const cachedDataJSON = localStorage.getItem(CACHE_KEY);
            if (cachedDataJSON) {
                try {
                    const cachedData = JSON.parse(cachedDataJSON);
                    if (cachedData.pokemon && cachedData.pokemon.length > 0) {
                        pokemonData.push(...cachedData.pokemon);
                        if (loadingProgressContainer) loadingProgressContainer.style.display = 'none';
                        isLoading = false; 
                        mainGenerateBtn.disabled = false;
                        stickyGenerateBtn.disabled = false;
                        validateLockedPokemonIds(); 
                        generateRandomPokemon(); return; 
                    }
                } catch (e) { console.error("Error parsing cached Pokémon data:", e); localStorage.removeItem(CACHE_KEY); }
            }
            
            if (loadingProgressContainer) loadingProgressContainer.style.display = 'block';
            if (loadingProgressBarElement) loadingProgressBarElement.style.width = '0%';
            if (loadingProgressTextElement) loadingProgressTextElement.textContent = translations[currentLang].progressText(0, POKEMON_LIMIT);
            let loadedCount = 0, totalToLoad = 0;
            try {
                const response = await fetch(`${BASE_API_URL}pokemon?limit=${POKEMON_LIMIT}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                totalToLoad = data.results.length;
                if (loadingProgressTextElement) loadingProgressTextElement.textContent = translations[currentLang].progressText(0, totalToLoad);
                const pokemonDetailsPromises = data.results.map(async (p) => {
                    let pokemonDetail = null;
                    try {
                        const detailResponse = await fetch(p.url);
                        if (!detailResponse.ok) throw new Error(`Detail fetch for ${p.name} failed: ${detailResponse.status}`);
                        const detailData = await detailResponse.json();
                        if (detailData.is_default === false) { return null; }
                        const speciesResponse = await fetch(detailData.species.url);
                        if (!speciesResponse.ok) throw new Error(`Species fetch for ${p.name} failed: ${speciesResponse.status}`);
                        const speciesData = await speciesResponse.json();
                        const generationUrl = speciesData.generation ? speciesData.generation.url : null;
                        let generation = generationUrl ? parseInt(generationUrl.match(/\/generation\/(\d+)\//)?.[1] || 0) : null;
                        let evolutionChainData = null, totalStages = 0;
                        if (speciesData.evolution_chain && speciesData.evolution_chain.url) {
                            const chainUrl = speciesData.evolution_chain.url;
                            if (evolutionChains.has(chainUrl)) evolutionChainData = evolutionChains.get(chainUrl);
                            else {
                                try {
                                    const chainResponse = await fetch(chainUrl);
                                    if (chainResponse.ok) { evolutionChainData = await chainResponse.json(); evolutionChains.set(chainUrl, evolutionChainData); }
                                } catch (chainError) { console.warn(`Evo chain fetch error for ${p.name}:`, chainError); }
                            }
                            if (evolutionChainData) totalStages = countStagesInChain(evolutionChainData.chain);
                        } else if (!speciesData.evolves_from_species) totalStages = 1;
                        let evolutionStage = -1;
                        if (evolutionChainData) evolutionStage = getEvolutionStage(detailData.name, evolutionChainData.chain);
                        else if (!speciesData.evolves_from_species) evolutionStage = 0;
                        pokemonDetail = {
                            id: detailData.id, name: detailData.name,
                            germanName: speciesData.names.find(name => name.language.name === 'de')?.name || null,
                            types: detailData.types.map(typeInfo => typeInfo.type.name),
                            image: detailData.sprites.other['official-artwork'].front_default || detailData.sprites.front_default,
                            shinyImage: detailData.sprites.other['official-artwork'].front_shiny || detailData.sprites.front_shiny,
                            generation, evolutionStage, totalStages,
                            isLegendary: speciesData.is_legendary, isMythical: speciesData.is_mythical
                        };
                    } catch (error) { console.warn(`Error processing ${p.name}: ${error.message}`);} 
                    finally {
                        loadedCount++;
                        const progressPercent = totalToLoad > 0 ? (loadedCount / totalToLoad) * 100 : 0;
                        if (loadingProgressBarElement) loadingProgressBarElement.style.width = `${progressPercent}%`;
                        if (loadingProgressTextElement) loadingProgressTextElement.textContent = translations[currentLang].progressText(loadedCount, totalToLoad);
                    }
                    return pokemonDetail;
                });
                const results = await Promise.all(pokemonDetailsPromises);
                pokemonData.push(...results.filter(p => p !== null));
                pokemonData.sort((a, b) => a.id - b.id);
                try { localStorage.setItem(CACHE_KEY, JSON.stringify({ pokemon: pokemonData })); } 
                catch (e) { console.error("Error saving Pokémon data to cache:", e); }
            } catch (error) { console.error("Fehler beim Laden der Pokémon-Daten:", error); statusElement.textContent = `${translations[currentLang].loadingError} ${error.message}`; } 
            finally { 
                isLoading = false; 
                mainGenerateBtn.disabled = false;
                stickyGenerateBtn.disabled = false;
                if (loadingProgressContainer) loadingProgressContainer.style.display = 'none'; 
                validateLockedPokemonIds();
                generateRandomPokemon(); 
            }
        }

        function filterPokemon() {
            let filtered = [...pokemonData];
            const selectedGens = Array.from(document.querySelectorAll('.gen-checkbox:checked')).map(cb => parseInt(cb.value));
            if (selectedGens.length === 0 && document.querySelectorAll('.gen-checkbox').length > 0) return []; 
            if (selectedGens.length > 0) filtered = filtered.filter(p => p.generation !== null && selectedGens.includes(p.generation));
            
            const selectedTypes = Array.from(document.querySelectorAll('.type-checkbox:checked')).map(cb => cb.id);
            if (selectedTypes.length === 0 && document.querySelectorAll('.type-checkbox').length > 0) return [];
            if (selectedTypes.length > 0) filtered = filtered.filter(p => p.types.some(type => selectedTypes.includes(type)));

            const selectedEvoPositions = Array.from(document.querySelectorAll('.evo-position-checkbox:checked')).map(cb => parseInt(cb.value));
            if (selectedEvoPositions.length === 0 && document.querySelectorAll('.evo-position-checkbox').length > 0) return [];
            if (selectedEvoPositions.length > 0) filtered = filtered.filter(p => selectedEvoPositions.includes(p.evolutionStage));
            
            const selectedChainLengths = Array.from(document.querySelectorAll('.chain-length-checkbox:checked')).map(cb => parseInt(cb.value));
            if (selectedChainLengths.length === 0 && document.querySelectorAll('.chain-length-checkbox').length > 0) return [];
            if (selectedChainLengths.length > 0) filtered = filtered.filter(p => selectedChainLengths.includes(p.totalStages));

            const includeLegendary = document.getElementById('includeLegendary').checked;
            const includeMythical = document.getElementById('includeMythical').checked;
            const specialCheckboxesExist = document.querySelectorAll('.special-checkbox').length > 0;
            if (specialCheckboxesExist && !includeLegendary && !includeMythical) filtered = filtered.filter(p => !p.isLegendary && !p.isMythical);
            else {
                if (document.getElementById('includeLegendary') && !includeLegendary) filtered = filtered.filter(p => !p.isLegendary);
                if (document.getElementById('includeMythical') && !includeMythical) filtered = filtered.filter(p => !p.isMythical);
            }
            return filtered;
        }

        function validateLockedPokemonIds() {
            if (pokemonData.length > 0 && lockedPokemonIds.size > 0) {
                const currentPokemonIds = new Set(pokemonData.map(p => p.id));
                let changed = false;
                lockedPokemonIds.forEach(id => {
                    if (!currentPokemonIds.has(id)) {
                        lockedPokemonIds.delete(id);
                        changed = true;
                    }
                });
                if (changed) {
                    localStorage.setItem(LOCKED_POKEMON_CACHE_KEY, JSON.stringify(Array.from(lockedPokemonIds)));
                }
            }
        }

        function createPokemonCard(pokemon) {
            const card = document.createElement('div');
            card.className = 'pokemon-card';
            const displayedName = currentLang === 'de' && pokemon.germanName ? pokemon.germanName : capitalizeFirstLetter(pokemon.name);
            const pokemonDbUrl = `${POKEMONDB_URL}${pokemon.name}`;
            
            const typeHtml = pokemon.types.map(type => {
                const typeNameTranslated = translations[currentLang][`type_${type}`] || capitalizeFirstLetter(type);
                const typeAltText = `${typeNameTranslated} ${translations[currentLang].typesLabelShort || 'Type'}`;
                return `
                    <div class="pokemon-type-item" title="${typeNameTranslated}">
                        <img src="${TYPE_ICON_BASE_URL}${type}.svg" class="type-icon" alt="${typeAltText}">
                        <span class="pokemon-type-name">${typeNameTranslated}</span>
                    </div>`;
            }).join('');
            
            let evolutionText = `${translations[currentLang].cardEvolution}: Unbekannt`;
            if (pokemon.evolutionStage !== -1 && pokemon.totalStages !== undefined && pokemon.totalStages > 0) {
                    const numberOfEvolutions = pokemon.totalStages - 1; 
                    evolutionText = `${translations[currentLang].cardEvolution}: ${pokemon.evolutionStage}/${numberOfEvolutions}`;
                    if (pokemon.evolutionStage === 0 && pokemon.totalStages === 1) evolutionText += ` ${translations[currentLang].cardEvolutionNoEvo}`;
            } else if (pokemon.evolutionStage !== -1) { 
                    evolutionText = `${translations[currentLang].cardEvolution}: ${translations[currentLang].cardEvolutionStage} ${pokemon.evolutionStage}`;
            }

            const isCurrentlyLocked = lockedPokemonIds.has(pokemon.id);
            const lockIconClass = isCurrentlyLocked ? 'fa-lock locked' : 'fa-unlock';
            const lockIconTitle = isCurrentlyLocked ? translations[currentLang].tooltipUnlock : translations[currentLang].tooltipLock;

            card.innerHTML = `
                <div class="pokemon-image">
                    <i class="fas ${lockIconClass} lock-icon" data-pokemon-id="${pokemon.id}" title="${lockIconTitle}"></i>
                    <img src="${pokemon.image || 'https://placehold.co/120x120/e0e0e0/333?text=Bild+fehlt'}" 
                         alt="${pokemon.name}"
                         loading="lazy"  
                         data-normal="${pokemon.image || 'https://placehold.co/120x120/e0e0e0/333?text=Bild+fehlt'}"
                         data-shiny="${pokemon.shinyImage || 'https://placehold.co/120x120/e0e0e0/333?text=Shiny+fehlt'}"
                         onclick="toggleShiny(this)"
                         onerror="this.onerror=null; this.src='https://placehold.co/120x120/e0e0e0/333?text=Fehler'; this.dataset.normal='https://placehold.co/120x120/e0e0e0/333?text=Fehler';this.dataset.shiny='https://placehold.co/120x120/e0e0e0/333?text=Fehler';">
                    <span class="shiny-indicator ${pokemon.shinyImage && pokemon.shinyImage.includes('sparkles-icon.png') ? 'custom-icon' : ''}">
                        ${pokemon.shinyImage && pokemon.shinyImage.includes('sparkles-icon.png') ? '<img src="sparkles-icon.png" alt="Sparkles Icon" width=32 height=32/>' : '✨'}
                    </span>
                </div>
                <div class="pokemon-info">
                    <h3 class="pokemon-name"><a href="${pokemonDbUrl}" target="_blank" class="pokedex-link">#${pokemon.id} ${displayedName}</a></h3>
                    <p class="pokemon-details">${translations[currentLang].cardGeneration}: ${pokemon.generation !== null ? pokemon.generation : 'Unbekannt'}</p>
                    <p class="pokemon-details">${evolutionText}</p>
                    <div class="pokemon-types">${typeHtml}</div>
                    ${(pokemon.isLegendary || pokemon.isMythical) ? `<p class="pokemon-details"><strong>${[pokemon.isLegendary ? translations[currentLang].includeLegendaryLabel : null, pokemon.isMythical ? translations[currentLang].includeMythicalLabel : null].filter(Boolean).join(', ')}</strong></p>` : ''}
                </div>`;
            
            const lockIconEl = card.querySelector('.lock-icon');
            if (lockIconEl) {
                lockIconEl.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    toggleLockPokemon(pokemon.id);
                });
            }
            return card;
        }


        function generateRandomPokemon() {
            if (isLoading && loadingProgressContainer && loadingProgressContainer.style.display !== 'none') return;
            if (isLoading) { 
                document.getElementById('status').textContent = translations[currentLang].loadingData; 
                return; 
            }
            if (pokemonData.length === 0) { 
                document.getElementById('status').textContent = translations[currentLang].status_initial_prompt;
                return;
            }
            
            validateLockedPokemonIds(); 
            countForNewPokemons = parseInt(document.getElementById('count').value) || 0;
            const statusElement = document.getElementById('status');
            
            lockedPokemonResultsContainer.innerHTML = "";
            resultsContainer.innerHTML = "";

            // Display Locked Pokemon (always sorted by ID)
            let displayedLockedPokemons = [];
            if (lockedPokemonIds.size > 0) {
                lockedPokemonIds.forEach(id => {
                    const pokemon = pokemonData.find(p => p.id === id);
                    if (pokemon) {
                        displayedLockedPokemons.push(pokemon);
                    }
                });
                displayedLockedPokemons.sort((a,b) => a.id - b.id).forEach(p => {
                    lockedPokemonResultsContainer.appendChild(createPokemonCard(p));
                });
                lockedPokemonSectionContainer.style.display = 'block';
            } else {
                lockedPokemonSectionContainer.style.display = 'none';
            }
            
            // Prepare and Generate New Pokemon List
            const filteredCandidates = filterPokemon();
            const availableForRandom = filteredCandidates.filter(p => !lockedPokemonIds.has(p.id));
            
            let newRandomPokemonList = [];
            if (availableForRandom.length > 0 && countForNewPokemons > 0) {
                if (countForNewPokemons >= availableForRandom.length) {
                    newRandomPokemonList = [...availableForRandom];
                } else {
                    // Select random ones *first* if not sorting randomly later
                    if (currentSortCriteria !== 'random') {
                         newRandomPokemonList = [...availableForRandom].sort(() => 0.5 - Math.random()).slice(0, countForNewPokemons);
                    } else {
                         newRandomPokemonList = [...availableForRandom]; // Will be shuffled later
                    }
                }
            }

            // Sort the New Pokemon List
            sortPokemonList(newRandomPokemonList);
            
            // Display New Pokemon
            newRandomPokemonList.forEach(p => {
                resultsContainer.appendChild(createPokemonCard(p));
            });

            // Update Status Message
            const numLocked = displayedLockedPokemons.length;
            const numGenerated = newRandomPokemonList.length;
            const numTotalPossibleNew = availableForRandom.length;

            if (numLocked === 0 && numGenerated === 0 && countForNewPokemons === 0) {
                statusElement.textContent = translations[currentLang].status_initial_prompt;
            } else if (numLocked > 0 && countForNewPokemons === 0) {
                statusElement.textContent = translations[currentLang].status_locked_only(numLocked);
            } else if (numLocked > 0 && numGenerated > 0) {
                 statusElement.textContent = translations[currentLang].status_locked_and_generated(numLocked, numGenerated, numTotalPossibleNew);
            } else if (numLocked > 0 && numGenerated === 0 && countForNewPokemons > 0) {
                statusElement.textContent = translations[currentLang].status_locked_no_new_match(numLocked);
            } else if (numLocked === 0 && numGenerated > 0) {
                statusElement.textContent = translations[currentLang].status_generated_only(numGenerated, numTotalPossibleNew);
            } else if (numLocked === 0 && numGenerated === 0 && countForNewPokemons > 0) {
                if (filterPokemon().length === 0) { 
                    statusElement.textContent = translations[currentLang].status_no_pokemon_at_all;
                } else { 
                    statusElement.textContent = translations[currentLang].status_no_new_match;
                }
            } else {
                statusElement.textContent = translations[currentLang].status_initial_prompt; 
            }
            
            updateSortIcons();
            handleScroll(); 
        }

        function sortPokemonList(list) {
            if (!list || list.length === 0) return;

            const directionMultiplier = currentSortDirection === 'asc' ? 1 : -1;

            switch (currentSortCriteria) {
                case 'id':
                    list.sort((a, b) => (a.id - b.id) * directionMultiplier);
                    break;
                case 'name':
                    list.sort((a, b) => {
                         const nameA = currentLang === 'de' && a.germanName ? a.germanName : a.name;
                         const nameB = currentLang === 'de' && b.germanName ? b.germanName : b.name;
                         return nameA.localeCompare(nameB, currentLang) * directionMultiplier;
                    });
                    break;
                case 'type':
                    list.sort((a, b) => {
                        const typeA = a.types.length > 0 ? a.types[0] : '';
                        const typeB = b.types.length > 0 ? b.types[0] : '';
                        // Sorting by internal English type name for consistency
                        return typeA.localeCompare(typeB) * directionMultiplier;
                    });
                    break;
                case 'random':
                    // Fisher-Yates (Knuth) Shuffle
                    for (let i = list.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [list[i], list[j]] = [list[j], list[i]];
                    }
                    break;
                default: // Default to ID Ascending
                     list.sort((a, b) => a.id - b.id);
            }
        }

        function updateSortIcons() {
             document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.classList.remove('active');
                if (icon.dataset.sort === currentSortCriteria) {
                    icon.classList.add('active');
                }
             });

             if (currentSortCriteria === 'random') {
                 sortDirectionIcon.className = 'fas'; // Clear direction icon
             } else {
                 sortDirectionIcon.className = `fas ${currentSortDirection === 'asc' ? 'fa-arrow-up-short-wide' : 'fa-arrow-down-wide-short'}`;
             }
        }


        function toggleShiny(imgElement) {
            const currentSrc = imgElement.src;
            const normalSrc = imgElement.dataset.normal;
            const shinySrc = imgElement.dataset.shiny;
            const imageContainer = imgElement.parentElement;
            const indicator = imageContainer.querySelector('.shiny-indicator');
            if (shinySrc && shinySrc !== 'https://placehold.co/120x120/e0e0e0/333?text=Shiny+fehlt' && shinySrc !== 'https://placehold.co/120x120/e0e0e0/333?text=Fehler') {
                 if (currentSrc === normalSrc) { imgElement.src = shinySrc; if (indicator) indicator.classList.add('active'); } 
                 else { imgElement.src = normalSrc; if (indicator) indicator.classList.remove('active'); }
            }
        }

        function toggleLockPokemon(pokemonId) {
            if (lockedPokemonIds.has(pokemonId)) {
                lockedPokemonIds.delete(pokemonId);
            } else {
                lockedPokemonIds.add(pokemonId);
            }
            localStorage.setItem(LOCKED_POKEMON_CACHE_KEY, JSON.stringify(Array.from(lockedPokemonIds)));
            generateRandomPokemon(); 
        }


        function capitalizeFirstLetter(string) {
            return string ? string.charAt(0).toUpperCase() + string.slice(1) : '';
        }
        
        function initializeToggleAllIcons() {
            document.querySelectorAll('.toggle-all-icon').forEach(icon => {
                const groupClass = icon.dataset.group;
                if (!groupClass) return;
                icon.addEventListener('click', function(e) {
                    e.stopPropagation(); 
                    const checkboxesInGroup = document.querySelectorAll(`.${groupClass}`);
                    if (checkboxesInGroup.length === 0) return;
                    const allCurrentlySelected = Array.from(checkboxesInGroup).every(cb => cb.checked);
                    checkboxesInGroup.forEach(cb => { cb.checked = !allCurrentlySelected; });
                    updateToggleIcon(groupClass); 
                });
                const checkboxesInGroup = document.querySelectorAll(`.${groupClass}`);
                checkboxesInGroup.forEach(checkbox => {
                    checkbox.addEventListener('change', () => { updateToggleIcon(groupClass); });
                });
            });
        }
        
        function setDefaultFiltersChecked() {
            const filterGroupsClasses = ['.gen-checkbox', '.type-checkbox', '.evo-position-checkbox', '.chain-length-checkbox', '.special-checkbox'];
            filterGroupsClasses.forEach(groupClass => {
                document.querySelectorAll(groupClass).forEach(checkbox => { checkbox.checked = true; });
                const iconForGroup = document.querySelector(`.toggle-all-icon[data-group="${groupClass.substring(1)}"]`);
                if (iconForGroup) updateToggleIcon(groupClass.substring(1));
            });
        }

        function initializeCollapsibles() {
            document.querySelectorAll('.control-group.collapsible .control-group-header').forEach(header => {
                header.addEventListener('click', function() {
                    const controlGroup = this.closest('.control-group.collapsible');
                    if (!controlGroup) return; 
                    const content = controlGroup.querySelector('.collapsible-content');
                    if (!content) return;

                    controlGroup.classList.toggle('is-closed');
                    if (controlGroup.classList.contains('is-closed')) {
                        content.style.maxHeight = '0';
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                    }
                });
                 const controlGroup = header.closest('.control-group.collapsible');
                 const content = controlGroup.querySelector('.collapsible-content');
                 if (content) { 
                    if (!controlGroup.classList.contains('is-closed')) {
                        content.style.maxHeight = content.scrollHeight + "px";
                    } else {
                        content.style.maxHeight = '0';
                    }
                 }
            });

            const toggleAllFiltersButton = document.getElementById('toggleAllFiltersBtn');
            if (toggleAllFiltersButton) {
                toggleAllFiltersButton.addEventListener('click', function() {
                    allFiltersExpanded = !allFiltersExpanded; 
                    this.textContent = translations[currentLang][allFiltersExpanded ? 'collapseAllLabel' : 'expandAllLabel'];
                    this.setAttribute('data-i18n', allFiltersExpanded ? 'collapseAllLabel' : 'expandAllLabel');

                    document.querySelectorAll('.control-group.collapsible').forEach(group => {
                        const content = group.querySelector('.collapsible-content');
                        if (content) {
                            if (allFiltersExpanded) { 
                                group.classList.remove('is-closed');
                                content.style.maxHeight = content.scrollHeight + "px";
                            } else { 
                                group.classList.add('is-closed');
                                content.style.maxHeight = '0';
                            }
                        }
                    });
                });
            }
        }
        
        function handleScroll() {
            const showSticky = (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) && pokemonData.length > 0;
            
            if (scrollToTopBtn) {
                scrollToTopBtn.style.display = showSticky ? "block" : "none";
            }

            if (controlsDiv && stickyGenerateBtn && mainGenerateBtn && sortingControls) {
                const controlsBottom = controlsDiv.getBoundingClientRect().bottom;
                const showTopControls = controlsBottom < 50 && pokemonData.length > 0;
                
                stickyGenerateBtn.style.display = showTopControls ? "block" : "none";
                sortingControls.style.display = showTopControls ? "flex" : "none"; // Use flex for display
                
                const isDisabled = isLoading || pokemonData.length === 0;
                stickyGenerateBtn.disabled = isDisabled; 
                mainGenerateBtn.disabled = isDisabled; 
            }
        }

        // --- Initialize Event Listeners ---
        document.getElementById('count').addEventListener('input', () => {
            countForNewPokemons = parseInt(document.getElementById('count').value) || 0;
        });
        mainGenerateBtn.addEventListener('click', generateRandomPokemon);
        stickyGenerateBtn.addEventListener('click', generateRandomPokemon);
        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({top: 0, behavior: 'smooth'});
        });

        document.querySelectorAll('.language-switcher img').forEach(img => {
            img.addEventListener('click', function() { setLanguage(this.dataset.lang); localStorage.setItem('language', this.dataset.lang); });
        });
        document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
        
        // Sorting Controls Event Listeners
        document.querySelectorAll('.sort-icon').forEach(icon => {
            icon.addEventListener('click', function() {
                const newSortCriteria = this.dataset.sort;

                if (newSortCriteria === currentSortCriteria && newSortCriteria !== 'random') {
                    // Toggle direction if same criteria (except random)
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    // Switch to new criteria, default to ascending
                    currentSortCriteria = newSortCriteria;
                    currentSortDirection = 'asc'; 
                }
                
                // No direction toggle needed for random, it just shuffles
                
                updateSortIcons(); 
                generateRandomPokemon(); // Regenerate and sort the #results list
            });
        });

        window.addEventListener('scroll', handleScroll);


        window.addEventListener('load', function() {
             const savedDarkMode = localStorage.getItem('darkMode');
             const isDarkMode = savedDarkMode === 'enabled';
             if (isDarkMode) document.body.classList.add('dark-mode');
             updateDarkModeIcon(isDarkMode);

             const savedLockedIds = localStorage.getItem(LOCKED_POKEMON_CACHE_KEY);
             if (savedLockedIds) {
                try {
                    lockedPokemonIds = new Set(JSON.parse(savedLockedIds).map(id => parseInt(id))); 
                } catch (e) {
                    console.error("Error loading locked Pokémon IDs:", e);
                    lockedPokemonIds = new Set();
                }
             }
             countForNewPokemons = parseInt(document.getElementById('count').value) || 10; 

             const savedLang = localStorage.getItem('language');
             setDefaultFiltersChecked(); 
             initializeToggleAllIcons(); 
             initializeCollapsibles(); 
             setLanguage((savedLang && translations[savedLang]) ? savedLang : 'de'); 
             
             document.getElementById('status').textContent = translations[currentLang].status_initial_prompt;
             updateSortIcons(); // Set initial sort icon state

             fetchPokemonDataFromAPI(); 
             handleScroll(); 
        });
    </script>
</body>
</html>
